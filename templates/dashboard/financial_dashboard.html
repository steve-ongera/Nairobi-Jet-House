{% extends "base/base.html" %}
{% load static %}

{% block title %}Financial Dashboard{% endblock %}

{% block content %}
<div class="pagetitle">
    <h1>Financial & Operational Dashboard</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Home</a></li>
            <li class="breadcrumb-item active">Dashboard</li>
        </ol>
    </nav>
</div>

<section class="section">
    <div class="row">
        <!-- Revenue Trend Chart -->
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Revenue Performance (Last 12 Months)</h5>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Flight Volume Chart -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Flight Volume by Month</h5>
                    <div class="chart-container">
                        <canvas id="flightVolumeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Aircraft Chart -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Top Performing Aircraft</h5>
                    <div class="chart-container">
                        <canvas id="aircraftRevenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Popular Routes Chart -->
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Most Popular Flight Legs</h5>
                    <div class="chart-container">
                        <canvas id="popularRoutesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row">
        <div class="col-lg-3 col-md-6">
            <div class="card info-card revenue-card">
                <div class="card-body">
                    <h5 class="card-title">Total Revenue <span>| Last 12 Months</span></h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-currency-dollar"></i>
                        </div>
                        <div class="ps-3">
                            <h6 id="totalRevenue">$0</h6>
                            <span class="text-success small pt-1 fw-bold" id="revenueGrowth">0%</span>
                            <span class="text-muted small pt-2 ps-1">vs previous period</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card info-card flights-card">
                <div class="card-body">
                    <h5 class="card-title">Total Flights <span>| Last 12 Months</span></h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-airplane"></i>
                        </div>
                        <div class="ps-3">
                            <h6 id="totalFlights">0</h6>
                            <span class="text-success small pt-1 fw-bold" id="flightsGrowth">0%</span>
                            <span class="text-muted small pt-2 ps-1">vs previous period</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card info-card aircraft-card">
                <div class="card-body">
                    <h5 class="card-title">Active Aircraft <span>| Currently</span></h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-airplane-fill"></i>
                        </div>
                        <div class="ps-3">
                            <h6 id="activeAircraft">0</h6>
                            <span class="text-success small pt-1 fw-bold">100%</span>
                            <span class="text-muted small pt-2 ps-1">utilization</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card info-card routes-card">
                <div class="card-body">
                    <h5 class="card-title">Unique Routes <span>| Last 12 Months</span></h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-signpost-split"></i>
                        </div>
                        <div class="ps-3">
                            <h6 id="uniqueRoutes">0</h6>
                            <span class="text-success small pt-1 fw-bold" id="routesGrowth">0%</span>
                            <span class="text-muted small pt-2 ps-1">vs previous period</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Include jQuery first -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<!-- Django data serialization using json_script -->
{{ monthly_revenue|json_script:"monthly-revenue-data" }}
{{ monthly_travel|json_script:"monthly-travel-data" }}
{{ top_aircraft|json_script:"top-aircraft-data" }}
{{ popular_legs|json_script:"popular-legs-data" }}

<script>
// Initialize Django data with proper error handling
let djangoData;
try {
    djangoData = {
        monthly_revenue: JSON.parse(document.getElementById('monthly-revenue-data').textContent || '[]'),
        monthly_travel: JSON.parse(document.getElementById('monthly-travel-data').textContent || '[]'),
        top_aircraft: JSON.parse(document.getElementById('top-aircraft-data').textContent || '[]'),
        popular_legs: JSON.parse(document.getElementById('popular-legs-data').textContent || '[]'),
        active_aircraft_count: {{ active_aircraft_count|default:"0" }},
        previous_revenue_total: parseFloat({{ previous_revenue_total|default:"0" }}) || 0,
        previous_flights_total: parseInt({{ previous_flights_total|default:"0" }}) || 0,
        previous_routes_count: parseInt({{ previous_routes_count|default:"0" }}) || 0
    };
} catch (error) {
    console.error('Error parsing Django data:', error);
    djangoData = {
        monthly_revenue: [],
        monthly_travel: [],
        top_aircraft: [],
        popular_legs: [],
        active_aircraft_count: 0,
        previous_revenue_total: 0,
        previous_flights_total: 0,
        previous_routes_count: 0
    };
}

$(document).ready(function() {
    console.log('Dashboard initializing...');
    
    // Check if djangoData exists and is properly loaded
    if (typeof djangoData === 'undefined') {
        console.error('djangoData is not defined');
        showError('Dashboard data not available. Please refresh the page.');
        return;
    }
    
    try {
        console.log('Django data loaded:', djangoData);
        
        // Data from Django context with safe parsing
        const monthlyRevenueData = djangoData.monthly_revenue || [];
        const monthlyTravelData = djangoData.monthly_travel || [];
        const topAircraftData = djangoData.top_aircraft || [];
        const popularLegsData = djangoData.popular_legs || [];

        console.log('Monthly revenue data:', monthlyRevenueData);
        console.log('Monthly travel data:', monthlyTravelData);

        // Check if we have any data
        if (monthlyRevenueData.length === 0 && monthlyTravelData.length === 0) {
            console.warn('No chart data found');
            showNoDataMessage();
        }

        // Process data for charts with error handling
        const revenueLabels = monthlyRevenueData.map(item => {
            try {
                // Handle both 'YYYY-MM' string format and date objects
                const dateStr = item.month;
                const [year, month] = dateStr.split('-');
                const date = new Date(year, month - 1); // month is 0-indexed
                return date.toLocaleString('default', { month: 'short', year: 'numeric' });
            } catch (e) {
                console.warn('Error parsing date:', item.month);
                return item.month || 'Unknown';
            }
        });
        
        const revenueTotals = monthlyRevenueData.map(item => parseFloat(item.total_revenue) || 0);
        const commissionTotals = monthlyRevenueData.map(item => parseFloat(item.commission) || 0);
        const ownerEarnings = monthlyRevenueData.map(item => parseFloat(item.owner_earnings) || 0);

        const travelLabels = monthlyTravelData.map(item => {
            try {
                const dateStr = item.month;
                const [year, month] = dateStr.split('-');
                const date = new Date(year, month - 1);
                return date.toLocaleString('default', { month: 'short', year: 'numeric' });
            } catch (e) {
                console.warn('Error parsing travel date:', item.month);
                return item.month || 'Unknown';
            }
        });
        const flightCounts = monthlyTravelData.map(item => parseInt(item.total_flights) || 0);

        const aircraftLabels = topAircraftData.map(item => 
            `${item.registration_number || 'Unknown'} (${item.model_name || 'Unknown Model'})`
        );
        const aircraftRevenue = topAircraftData.map(item => parseFloat(item.total_revenue) || 0);

        const routeLabels = popularLegsData.map(item => item.route_name || 'Unknown Route');
        const routeCounts = popularLegsData.map(item => parseInt(item.total_flights) || 0);

        // Calculate key metrics with safe math
        const totalRevenue = revenueTotals.reduce((a, b) => a + b, 0);
        const totalFlights = flightCounts.reduce((a, b) => a + b, 0);
        const uniqueRoutes = popularLegsData.length;
        const activeAircraft = djangoData.active_aircraft_count || 0;

        // Calculate growth compared to previous period
        const previousRevenue = djangoData.previous_revenue_total || 0;
        const previousFlights = djangoData.previous_flights_total || 0;
        const previousRoutes = djangoData.previous_routes_count || 0;

        const revenueGrowth = previousRevenue > 0 ? 
            ((totalRevenue - previousRevenue) / previousRevenue * 100).toFixed(1) : 0;
        const flightsGrowth = previousFlights > 0 ? 
            ((totalFlights - previousFlights) / previousFlights * 100).toFixed(1) : 0;
        const routesGrowth = previousRoutes > 0 ? 
            ((uniqueRoutes - previousRoutes) / previousRoutes * 100).toFixed(1) : 0;

        // Update metric cards with safe DOM manipulation
        updateMetricCard('totalRevenue', '$' + totalRevenue.toLocaleString('en-US', {maximumFractionDigits: 0}));
        updateMetricCard('totalFlights', totalFlights.toLocaleString());
        updateMetricCard('uniqueRoutes', uniqueRoutes.toString());
        updateMetricCard('activeAircraft', activeAircraft.toString());
        
        updateGrowthMetric('revenueGrowth', revenueGrowth);
        updateGrowthMetric('flightsGrowth', flightsGrowth);
        updateGrowthMetric('routesGrowth', routesGrowth);

        // Initialize charts
        initializeCharts({
            revenue: { labels: revenueLabels, totals: revenueTotals, commissions: commissionTotals, earnings: ownerEarnings },
            flights: { labels: travelLabels, counts: flightCounts },
            aircraft: { labels: aircraftLabels, revenue: aircraftRevenue },
            routes: { labels: routeLabels, counts: routeCounts }
        });

        console.log('Dashboard initialization complete');

    } catch (error) {
        console.error('Error initializing dashboard:', error);
        showError('Error loading dashboard data: ' + error.message);
    }
});

// Helper functions
function updateMetricCard(elementId, value) {
    const element = $('#' + elementId);
    if (element.length) {
        element.text(value);
    } else {
        console.warn('Element not found:', elementId);
    }
}

function updateGrowthMetric(elementId, growth) {
    const element = $('#' + elementId);
    if (element.length) {
        element.removeClass('text-success text-danger text-muted');
        if (growth > 0) {
            element.addClass('text-success').text('+' + growth + '%');
        } else if (growth < 0) {
            element.addClass('text-danger').text(growth + '%');
        } else {
            element.addClass('text-muted').text('0%');
        }
    }
}

function showError(message) {
    $('.chart-container').each(function() {
        $(this).html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ' + message + '</div>');
    });
}

function showNoDataMessage() {
    $('.chart-container').each(function() {
        $(this).html('<div class="alert alert-info"><i class="fas fa-info-circle"></i> No data available for the selected period.</div>');
    });
}

function initializeCharts(data) {
    // Revenue Chart
    const revenueCanvas = document.getElementById('revenueChart');
    if (revenueCanvas && data.revenue.labels.length > 0) {
        console.log('Creating revenue chart...');
        const revenueCtx = revenueCanvas.getContext('2d');
        new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: data.revenue.labels,
                datasets: [
                    {
                        label: 'Total Revenue',
                        data: data.revenue.totals,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Owner Earnings',
                        data: data.revenue.earnings,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Company Commission',
                        data: data.revenue.commissions,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + context.raw.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Flight Volume Chart
    const flightVolumeCanvas = document.getElementById('flightVolumeChart');
    if (flightVolumeCanvas && data.flights.labels.length > 0) {
        console.log('Creating flight volume chart...');
        const flightVolumeCtx = flightVolumeCanvas.getContext('2d');
        new Chart(flightVolumeCtx, {
            type: 'bar',
            data: {
                labels: data.flights.labels,
                datasets: [{
                    label: 'Number of Flights',
                    data: data.flights.counts,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.raw + ' flights';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    }
                }
            }
        });
    }

    // Top Aircraft Chart
    const aircraftRevenueCanvas = document.getElementById('aircraftRevenueChart');
    if (aircraftRevenueCanvas && data.aircraft.labels.length > 0) {
        console.log('Creating aircraft revenue chart...');
        const aircraftRevenueCtx = aircraftRevenueCanvas.getContext('2d');
        new Chart(aircraftRevenueCtx, {
            type: 'bar',
            data: {
                labels: data.aircraft.labels,
                datasets: [{
                    label: 'Revenue Generated',
                    data: data.aircraft.revenue,
                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '$' + context.raw.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Popular Routes Chart
    const popularRoutesCanvas = document.getElementById('popularRoutesChart');
    if (popularRoutesCanvas && data.routes.labels.length > 0) {
        console.log('Creating popular routes chart...');
        const popularRoutesCtx = popularRoutesCanvas.getContext('2d');
        new Chart(popularRoutesCtx, {
            type: 'doughnut',
            data: {
                labels: data.routes.labels,
                datasets: [{
                    data: data.routes.counts,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(199, 199, 199, 0.7)',
                        'rgba(83, 102, 255, 0.7)',
                        'rgba(40, 159, 64, 0.7)',
                        'rgba(210, 99, 132, 0.7)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(199, 199, 199, 1)',
                        'rgba(83, 102, 255, 1)',
                        'rgba(40, 159, 64, 1)',
                        'rgba(210, 99, 132, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.raw + ' flights';
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });
    }
}
</script>
<style>
.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}
.card {
    margin-bottom: 20px;
}
.info-card {
    border-left: 4px solid #4e73df;
}
.info-card .card-icon {
    font-size: 2rem;
    color: #dddfeb;
    background: #4e73df;
}
.revenue-card .card-icon {
    background: #1cc88a !important;
}
.flights-card .card-icon {
    background: #36b9cc !important;
}
.aircraft-card .card-icon {
    background: #e74a3b !important;
}
.routes-card .card-icon {
    background: #f6c23e !important;
}
</style>
{% endblock %}