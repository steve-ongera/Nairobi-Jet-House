{% extends "base/base.html" %}
{% load static %}

{% block title %}Nairobi Jet House - Admin Dashboard{% endblock %}

{% block content %}
<div class="message-container" id="system-messages">
    {% for message in messages %}
    <div class="alert-message alert-{{ message.tags }}">
        {{ message }}
        <span class="close-message">&times;</span>
    </div>
    {% endfor %}
</div>

<div class="pagetitle">
    <h1>Dashboard</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="#">Home</a></li>
            <li class="breadcrumb-item active">Dashboard</li>
            <li class="breadcrumb-item">{{ request.user.username }}</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section dashboard">
    <div class="row">
        <!-- Left side columns -->
        <div class="col-lg-8">
            <div class="row">
                <!-- Clients Card -->
                <div class="col-xxl-4 col-md-6">
                    <div class="card info-card sales-card" style="border-left: 5px solid #3498db;">
                        <div class="card-body">
                            <h5 class="card-title">Total Clients</h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background-color: #3498db;">
                                    <i class="bi bi-people text-white"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>{{ total_clients }}</h6>
                                    <span class="text-success small pt-1 fw-bold"></span> 
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- End Clients Card -->

                <!-- Owners Card -->
                <div class="col-xxl-4 col-md-6">
                    <div class="card info-card revenue-card" style="border-left: 5px solid #2980b9;">
                        <div class="card-body">
                            <h5 class="card-title">Aircraft Owners</h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background-color: #2980b9;">
                                    <i class="bi bi-airplane text-white"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>{{ total_owners }}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- End Owners Card -->

                <!-- Aircraft Card -->
                <div class="col-xxl-4 col-md-6">
                    <div class="card info-card customers-card" style="border-left: 5px solid #1abc9c;">
                        <div class="card-body">
                            <h5 class="card-title">Aircraft Fleet</h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background-color: #1abc9c;">
                                    <i class="bi bi-airplane-engines text-white"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>{{ total_aircraft }}</h6>
                                    <span class="text-success small">{{ active_aircraft }} active</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- End Aircraft Card -->

                <!-- Revenue Card -->
                <div class="col-xxl-6 col-md-6">
                    <div class="card info-card revenue-card" style="border-left: 5px solid #3498db;">
                        <div class="card-body">
                            <h5 class="card-title">Monthly Revenue</h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background-color: #3498db;">
                                    <i class="bi bi-cash-stack text-white"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>${{ monthly_revenue|floatformat:2 }}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- End Revenue Card -->

                <!-- Bookings Card -->
                <div class="col-xxl-6 col-md-6">
                    <div class="card info-card sales-card" style="border-left: 5px solid #9b59b6;">
                        <div class="card-body">
                            <h5 class="card-title">Today's Bookings</h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background-color: #9b59b6;">
                                    <i class="bi bi-calendar-check text-white"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>{{ today_bookings }}</h6>
                                    <span class="text-muted small">{{ total_bookings }} total</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- End Bookings Card -->

                <!-- Revenue Trend Chart -->
                <div class="col-12">
                    <div class="card">
                        <div class="filter">
                            <a class="icon" href="#" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></a>
                            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                                <li class="dropdown-header text-start">
                                    <h6>Filter</h6>
                                </li>
                                <li><a class="dropdown-item filter-revenue active" href="#" data-period="7">Last 7 Days</a></li>
                                <li><a class="dropdown-item filter-revenue" href="#" data-period="30">Last 30 Days</a></li>
                                <li><a class="dropdown-item filter-revenue" href="#" data-period="90">Last 90 Days</a></li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">Revenue Trend</h5>
                            <div class="chart-container" style="position: relative; height:300px; width:100%">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div><!-- End Revenue Trend Chart -->

                <!-- Recent Bookings -->
                <div class="col-12">
                    <div class="card recent-sales overflow-auto">
                        <div class="filter">
                            <a class="icon" href="#" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></a>
                            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                                <li class="dropdown-header text-start">
                                    <h6>Filter</h6>
                                </li>
                                <li><a class="dropdown-item" href="#">Today</a></li>
                                <li><a class="dropdown-item" href="#">This Week</a></li>
                                <li><a class="dropdown-item" href="#">This Month</a></li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">Recent Bookings <span>| Today</span></h5>
                            <table class="table table-borderless datatable">
                                <thead>
                                    <tr>
                                        <th scope="col">Booking ID</th>
                                        <th scope="col">Client</th>
                                        <th scope="col">Aircraft</th>
                                        <th scope="col">Departure</th>
                                        <th scope="col">Status</th>
                                        <th scope="col">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for booking in recent_bookings %}
                                    <tr>
                                        <td><a href="#">#{{ booking.booking_order_id }}</a></td>
                                        <td>{{ booking.client.get_full_name }}</td>
                                        <td>{{ booking.aircraft.model_name }}</td>
                                        <td>{{ booking.flight_legs.first.departure_datetime|date:"M d, Y H:i" }}</td>
                                       <td>
                                        <span class="badge 
                                            {% if booking.status == 'confirmed' %}
                                                bg-success
                                            {% elif booking.status == 'complete' %}
                                                bg-primary
                                            {% elif booking.status == 'cancelled' %}
                                                bg-danger
                                            {% else %}
                                                bg-warning
                                            {% endif %}">
                                            {{ booking.get_status_display }}
                                        </span>
</td>


                                        <td>${{ booking.total_price }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div><!-- End Recent Bookings -->

                <!-- Aircraft Type Distribution -->
                <div class="col-12">
                    <div class="card top-selling overflow-auto">
                        <div class="filter">
                            <a class="icon" href="#" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></a>
                            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                                <li class="dropdown-header text-start">
                                    <h6>Filter</h6>
                                </li>
                                <li><a class="dropdown-item" href="#">All Types</a></li>
                                <li><a class="dropdown-item" href="#">Active Only</a></li>
                            </ul>
                        </div>
                        <div class="card-body pb-0">
                            <h5 class="card-title">Aircraft Type Distribution</h5>
                            <div class="chart-container" style="position: relative; height:300px; width:100%">
                                <canvas id="aircraftTypeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div><!-- End Aircraft Type Distribution -->
            </div>
        </div><!-- End Left side columns -->

        <!-- Right side columns -->
        <div class="col-lg-4">
            <!-- Booking Status Chart -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Booking Status</h5>
                    <div class="chart-container" style="position: relative; height:300px; width:100%">
                        <canvas id="bookingStatusChart"></canvas>
                    </div>
                </div>
            </div><!-- End Booking Status Chart -->

            <!-- Payment Methods Chart -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Payment Methods</h5>
                    <div class="chart-container" style="position: relative; height:300px; width:100%">
                        <canvas id="paymentChart"></canvas>
                    </div>
                </div>
            </div><!-- End Payment Methods Chart -->

            <!-- Active Flights -->
            <div class="card">
                <div class="card-body pb-0">
                    <h5 class="card-title">Active Flights</h5>
                    <div class="news">
                        {% for flight in active_flights %}
                        <div class="post-item clearfix">
                            <i class="bi bi-airplane-fill text-primary me-2"></i>
                            <h6><a href="#">{{ flight.aircraft.model_name }}</a></h6>
                            <p>
                                {{ flight.aircraft.registration_number }}<br>
                                Alt: {{ flight.altitude }}ft | Speed: {{ flight.speed }}kts
                            </p>
                        </div>
                        {% empty %}
                        <div class="post-item clearfix">
                            <p>No active flights at the moment</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div><!-- End Active Flights -->

            <!-- Recent Inquiries -->
            <div class="card">
                <div class="card-body pb-0">
                    <h5 class="card-title">Recent Inquiries</h5>
                    <div class="news">
                        {% for inquiry in recent_inquiries %}
                        <div class="post-item clearfix">
                            <i class="bi bi-question-circle-fill text-info me-2"></i>
                            <h6><a href="#">{{ inquiry.full_name }}</a></h6>
                            <p>
                                {{ inquiry.departure }} to {{ inquiry.destination }}<br>
                                {{ inquiry.travel_date }} | {{ inquiry.passengers }} pax
                            </p>
                        </div>
                        {% empty %}
                        <div class="post-item clearfix">
                            <p>No recent inquiries</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div><!-- End Recent Inquiries -->
        </div><!-- End Right side columns -->
    </div>
</section>

<!-- Chart Scripts -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    // Revenue Trend Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    const revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: JSON.parse('{{ revenue_labels|escapejs }}'),
            datasets: [{
                label: 'Daily Revenue ($)',
                data: JSON.parse('{{ revenue_data|escapejs }}'),
                backgroundColor: 'rgba(52, 152, 219, 0.2)',
                borderColor: '#3498db',
                borderWidth: 2,
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `$${context.raw.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Booking Status Chart
    const bookingStatusCtx = document.getElementById('bookingStatusChart').getContext('2d');
    const bookingStatusChart = new Chart(bookingStatusCtx, {
        type: 'doughnut',
        data: {
            labels: [
                {% for status in booking_status %}
                    '{{ status.status|title }}',
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for status in booking_status %}
                        {{ status.count }},
                    {% endfor %}
                ],
                backgroundColor: [
                    '#3498db', '#2980b9', '#1abc9c', '#9b59b6', '#34495e'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.raw} bookings`;
                        }
                    }
                }
            }
        }
    });

    // Payment Methods Chart
    const paymentCtx = document.getElementById('paymentChart').getContext('2d');
    const paymentChart = new Chart(paymentCtx, {
        type: 'pie',
        data: {
            labels: [
                {% for method, percent in payment_methods.items %}
                    '{{ method }}',
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for method, percent in payment_methods.items %}
                        {{ percent }},
                    {% endfor %}
                ],
                backgroundColor: [
                    '#3498db', '#2980b9', '#1abc9c', '#9b59b6'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.raw}%`;
                        }
                    }
                }
            }
        }
    });

    // Aircraft Type Chart
    const aircraftTypeCtx = document.getElementById('aircraftTypeChart').getContext('2d');
    const aircraftTypeChart = new Chart(aircraftTypeCtx, {
        type: 'bar',
        data: {
            labels: [
                {% for type in aircraft_types %}
                    '{{ type.name }}',
                {% endfor %}
            ],
            datasets: [{
                label: 'Number of Aircraft',
                data: [
                    {% for type in aircraft_types %}
                        {{ type.count }},
                    {% endfor %}
                ],
                backgroundColor: 'rgba(52, 152, 219, 0.7)',
                borderColor: 'rgba(52, 152, 219, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // Filter functionality
    document.querySelectorAll('.filter-revenue').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            
            document.querySelectorAll('.filter-revenue').forEach(el => {
                el.classList.remove('active');
            });
            this.classList.add('active');
            
            const period = this.getAttribute('data-period');
            console.log(`Would fetch revenue data for last ${period} days`);
        });
    });
});
</script>

<style>
/* Blue Theme */
.card {
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(52, 152, 219, 0.1);
    transition: all 0.3s ease;
    border: none;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(52, 152, 219, 0.15);
}

.card-icon {
    width: 50px;
    height: 50px;
    font-size: 1.5rem;
}

.badge {
    font-weight: 500;
    padding: 5px 10px;
}

.badge.bg-success {
    background-color: #1abc9c !important;
}

.badge.bg-warning {
    background-color: #f39c12 !important;
}

.badge.bg-danger {
    background-color: #e74c3c !important;
}

.pagetitle {
    margin-bottom: 1.5rem;
}

.alert-message {
    border-left: 4px solid #3498db;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 4px;
}

.table th {
    background-color: #f8f9fa;
    color: #3498db;
}

.filter .dropdown-menu {
    border: none;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.filter .dropdown-item:hover {
    background-color: #3498db;
    color: white;
}

.post-item {
    padding: 1rem 0;
    border-bottom: 1px solid #eee;
}

.post-item:last-child {
    border-bottom: none;
}

.post-item i {
    font-size: 1.2rem;
    margin-right: 10px;
}
</style>

{% endblock %}