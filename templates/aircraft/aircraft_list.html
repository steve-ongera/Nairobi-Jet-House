{% extends 'base/base.html' %}
{% load static %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}">
<div class="message-container" id="system-messages">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        <i class="bi {% if message.tags == 'success' %}bi-check-circle{% else %}bi-exclamation-triangle{% endif %} me-2"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>

<div class="pagetitle">
    <h1><i class="bi bi-airplane me-2"></i>Aircraft Management</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}"><i class="bi bi-house-door"></i> Home</a></li>
            <li class="breadcrumb-item active">Aircraft</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-jet-primary text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-list-ul me-2"></i>Aircraft List</h5>
                </div>
                
                <div class="card-body">
                    <!-- Search and Filter -->
                    <form method="GET" class="row mb-4">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" name="search" class="form-control" 
                                       placeholder="Search by registration, model, or owner..." 
                                       value="{{ search }}">
                                <button type="submit" class="btn btn-jet">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select name="is_active" class="form-select">
                                <option value="">All Status</option>
                                <option value="true" {% if is_active == 'true' %}selected{% endif %}>Active Only</option>
                                <option value="false" {% if is_active == 'false' %}selected{% endif %}>Inactive Only</option>
                            </select>
                        </div>
                        <div class="col-md-3 text-end">
                            <a href="{% url 'aircraft_list' %}" class="btn btn-outline-jet">
                                <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
                            </a>
                            <button class="btn btn-jet" id="addAircraftBtn">
                                <i class="bi bi-plus-lg me-1"></i> Add Aircraft
                            </button>
                        </div>
                    </form>
                    
                    <!-- Aircraft Table -->
                    <div class="table-responsive">
                        <table class="table table-hover datatable">
                            <thead class="bg-jet-light">
                                <tr>
                                    <th>Registration</th>
                                    <th>Model</th>
                                    <th>Type</th>
                                    <th>Owner</th>
                                    <th>Year</th>
                                    <th>Status</th>
                                    <th>Hourly Rate</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for aircraft in aircrafts %}
                                <tr>
                                    <td><strong>{{ aircraft.registration_number }}</strong></td>
                                    <td>{{ aircraft.model_name }}</td>
                                    <td>{{ aircraft.aircraft_type.name }}</td>
                                    <td>{{ aircraft.owner.get_full_name|default:aircraft.owner.username }}</td>
                                    <td>{{ aircraft.year_manufactured }}</td>
                                    <td>
                                        <span class="badge bg-{% if aircraft.is_active %}success{% else %}danger{% endif %}">
                                            {% if aircraft.is_active %}Active{% else %}Inactive{% endif %}
                                        </span>
                                    </td>
                                    <td>${{ aircraft.hourly_rate }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-jet view-aircraft" 
                                                data-aircraft-id="{{ aircraft.id }}"
                                                title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning edit-aircraft" 
                                                data-aircraft-id="{{ aircraft.id }}"
                                                title="Edit Aircraft">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-aircraft" 
                                                data-aircraft-id="{{ aircraft.id }}"
                                                title="Delete Aircraft">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <i class="bi bi-airplane text-muted" style="font-size: 2rem;"></i>
                                        <p class="text-muted mt-2">No aircraft found</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if aircrafts.has_other_pages %}
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mt-3">
                            {% if aircrafts.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1{% if search %}&search={{ search }}{% endif %}{% if is_active %}&is_active={{ is_active }}{% endif %}" aria-label="First">
                                    <span aria-hidden="true">&laquo;&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ aircrafts.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if is_active %}&is_active={{ is_active }}{% endif %}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% endif %}
                            
                            {% for num in aircrafts.paginator.page_range %}
                                {% if aircrafts.number == num %}
                                <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                                {% elif num > aircrafts.number|add:'-3' and num < aircrafts.number|add:'3' %}
                                <li class="page-item"><a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if is_active %}&is_active={{ is_active }}{% endif %}">{{ num }}</a></li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if aircrafts.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ aircrafts.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if is_active %}&is_active={{ is_active }}{% endif %}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ aircrafts.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}{% if is_active %}&is_active={{ is_active }}{% endif %}" aria-label="Last">
                                    <span aria-hidden="true">&raquo;&raquo;</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
                
                <div class="card-footer bg-jet-light">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Showing {{ aircrafts.start_index }} to {{ aircrafts.end_index }} of {{ aircrafts.paginator.count }} aircraft
                    </small>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- View Aircraft Modal -->
<div class="modal fade" id="viewAircraftModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-jet-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-airplane me-2"></i>
                    <span id="viewAircraftModalLabel">Aircraft Details</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="detail-row">
                            <span class="detail-label">Registration Number:</span>
                            <span class="detail-value" id="aircraft-registration">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Model Name:</span>
                            <span class="detail-value" id="aircraft-model">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Aircraft Type:</span>
                            <span class="detail-value" id="aircraft-type">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Owner:</span>
                            <span class="detail-value" id="aircraft-owner">-</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-row">
                            <span class="detail-label">Year Manufactured:</span>
                            <span class="detail-value" id="aircraft-year">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Base Airport:</span>
                            <span class="detail-value" id="aircraft-base">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Current Location:</span>
                            <span class="detail-value" id="aircraft-location">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Status:</span>
                            <span class="detail-value" id="aircraft-status">-</span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="detail-row">
                            <span class="detail-label">Hourly Rate:</span>
                            <span class="detail-value" id="aircraft-rate">-</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-row">
                            <span class="detail-label">Minimum Hours:</span>
                            <span class="detail-value" id="aircraft-min-hours">-</span>
                        </div>
                    </div>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Features:</span>
                    <div id="aircraft-features" class="p-3 bg-light rounded mt-2">-</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Aircraft Modal -->
<div class="modal fade" id="editAircraftModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-jet-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-pencil me-2"></i>
                    <span id="editAircraftModalLabel">Edit Aircraft</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editAircraftForm">
                <div class="modal-body">
                    <input type="hidden" id="edit-aircraft-id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-registration" class="form-label">Registration Number</label>
                                <input type="text" class="form-control" id="edit-registration" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-model" class="form-label">Model Name</label>
                                <input type="text" class="form-control" id="edit-model" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-type" class="form-label">Aircraft Type</label>
                                <select class="form-select" id="edit-type" required>
                                    <option value="">Select Type</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="edit-owner" class="form-label">Owner</label>
                                <select class="form-select" id="edit-owner" required>
                                    <option value="">Select Owner</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-year" class="form-label">Year Manufactured</label>
                                <input type="number" class="form-control" id="edit-year" min="1900" max="2030" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-base" class="form-label">Base Airport (ICAO)</label>
                                <input type="text" class="form-control" id="edit-base" maxlength="10">
                            </div>
                            <div class="mb-3">
                                <label for="edit-location" class="form-label">Current Location (ICAO)</label>
                                <input type="text" class="form-control" id="edit-location" maxlength="10">
                            </div>
                            <div class="mb-3">
                                <label for="edit-status" class="form-label">Status</label>
                                <select class="form-select" id="edit-status">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-rate" class="form-label">Hourly Rate ($)</label>
                                <input type="number" class="form-control" id="edit-rate" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-min-hours" class="form-label">Minimum Hours</label>
                                <input type="number" class="form-control" id="edit-min-hours" step="0.1" min="0" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit-features" class="form-label">Features</label>
                        <textarea class="form-control" id="edit-features" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-jet">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteAircraftModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this aircraft?</p>
                <p class="fw-bold" id="delete-aircraft-info"></p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-aircraft-delete">
                    <i class="bi bi-trash me-1"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .detail-row {
        border-bottom: 1px solid #eee;
        padding: 10px 0;
        display: flex;
        justify-content: space-between;
    }
    
    .detail-row:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        font-weight: bold;
        color: #495057;
    }
    
    .detail-value {
        color: #6c757d;
    }
    
    .table-hover tbody tr:hover {
        background-color: var(--jet-light);
    }
    
    .datatable th {
        background-color: var(--jet-light);
        font-weight: 600;
    }
</style>


<!-- Add Aircraft Modal (similar to edit but with empty fields) -->
<script>
$(document).ready(function() {
    // View Aircraft Modal
    $('.view-aircraft').click(function() {
        const aircraftId = $(this).data('aircraft-id');
        const modal = new bootstrap.Modal(document.getElementById('viewAircraftModal'));
        
        // Show loading state
        $('#viewAircraftModal .modal-body p, #aircraft-features').text('Loading...');
        
        // Fetch aircraft details via AJAX
        $.ajax({
            url: `/aircraft/${aircraftId}/detail/`,
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    const aircraft = response.data;
                    
                    // Update modal content
                    $('#aircraft-registration').text(aircraft.registration_number);
                    $('#aircraft-model').text(aircraft.model_name);
                    $('#aircraft-type').text(aircraft.aircraft_type_name || 'N/A');
                    $('#aircraft-owner').text(aircraft.owner_name || 'N/A');
                    $('#aircraft-year').text(aircraft.year_manufactured || 'N/A');
                    
                    // Use the display versions of airport info
                    $('#aircraft-base').text(aircraft.base_airport_display || 'N/A');
                    $('#aircraft-location').text(aircraft.current_location_display || 'N/A');
                    
                    $('#aircraft-status').html(aircraft.is_active ? 
                        '<span class="badge bg-success">Active</span>' : 
                        '<span class="badge bg-danger">Inactive</span>');
                    $('#aircraft-rate').text(aircraft.hourly_rate ? '$' + aircraft.hourly_rate : 'N/A');
                    $('#aircraft-min-hours').text(aircraft.minimum_hours || 'N/A');
                    $('#aircraft-features').text(aircraft.features || 'N/A');
                    
                    // Update modal title
                    $('#viewAircraftModalLabel').text(`Aircraft: ${aircraft.registration_number}`);
                } else {
                    alert(response.error || 'Failed to load aircraft details');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error fetching aircraft details:', error);
                alert('Error fetching aircraft details: ' + error);
            },
            complete: function() {
                modal.show();
            }
        });
    });

    // Edit Aircraft Modal - Fixed version
    $(document).on('click', '.edit-aircraft', function() {
        const aircraftId = $(this).data('aircraft-id');
        console.log('Edit aircraft clicked, ID:', aircraftId); // Debug log
        
        if (!aircraftId) {
            alert('Aircraft ID not found');
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('editAircraftModal'));
        
        // Show loading state
        $('#editAircraftModal .modal-body').append('<div id="loading-spinner">Loading...</div>');
        
        // Load dropdown data first
        loadDropdownData().then(function() {
            // Then fetch aircraft details
            $.ajax({
                url: `/aircraft/${aircraftId}/detail/`,
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    console.log('Aircraft details response:', response); // Debug log
                    
                    if (response.success) {
                        const aircraft = response.data;
                        
                        // Populate form fields
                        $('#edit-aircraft-id').val(aircraft.id);
                        $('#edit-registration').val(aircraft.registration_number);
                        $('#edit-model').val(aircraft.model_name);
                        $('#edit-year').val(aircraft.year_manufactured || '');
                        $('#edit-base').val(aircraft.base_airport || '');
                        $('#edit-location').val(aircraft.current_location || '');
                        $('#edit-features').val(aircraft.features || '');
                        $('#edit-rate').val(aircraft.hourly_rate || '');
                        $('#edit-min-hours').val(aircraft.minimum_hours || '');
                        $('#edit-status').val(aircraft.is_active ? 'true' : 'false');
                        
                        // Set owner and type after dropdown is populated
                        if (aircraft.owner_id) {
                            $('#edit-owner').val(aircraft.owner_id);
                        }
                        if (aircraft.aircraft_type_id) {
                            $('#edit-type').val(aircraft.aircraft_type_id);
                        }
                        
                        // Update modal title
                        $('#editAircraftModalLabel').text(`Edit Aircraft: ${aircraft.registration_number}`);
                        
                        // Remove loading spinner
                        $('#loading-spinner').remove();
                    } else {
                        alert(response.error || 'Failed to load aircraft details');
                        $('#loading-spinner').remove();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching aircraft details:', xhr.responseText);
                    alert('Error fetching aircraft details: ' + error);
                    $('#loading-spinner').remove();
                },
                complete: function() {
                    modal.show();
                }
            });
        }).catch(function(error) {
            console.error('Error loading dropdown data:', error);
            alert('Error loading form data');
        });
    });

    // Load dropdown data for edit form - Modified to return Promise
    function loadDropdownData() {
        return new Promise(function(resolve, reject) {
            // Check if dropdowns are already loaded
            if ($('#edit-type option').length > 1 && $('#edit-owner option').length > 1) {
                resolve();
                return;
            }
            
            $.ajax({
                url: '/aircraft/dropdown-data/',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    console.log('Dropdown data response:', response); // Debug log
                    
                    if (response.success) {
                        // Populate owners dropdown
                        let ownerSelect = $('#edit-owner');
                        ownerSelect.empty().append('<option value="">Select Owner</option>');
                        if (response.owners && response.owners.length > 0) {
                            response.owners.forEach(function(owner) {
                                let name = owner.first_name && owner.last_name ? 
                                    `${owner.first_name} ${owner.last_name}` : owner.username;
                                ownerSelect.append(`<option value="${owner.id}">${name}</option>`);
                            });
                        }
                        
                        // Populate aircraft types dropdown
                        let typeSelect = $('#edit-type');
                        typeSelect.empty().append('<option value="">Select Type</option>');
                        if (response.aircraft_types && response.aircraft_types.length > 0) {
                            response.aircraft_types.forEach(function(type) {
                                typeSelect.append(`<option value="${type.id}">${type.name}</option>`);
                            });
                        }
                        
                        resolve();
                    } else {
                        reject('Failed to load dropdown data');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading dropdown data:', xhr.responseText);
                    reject(error);
                }
            });
        });
    }

    // Submit Edit Form - Fixed version with proper JSON handling
    $(document).on('submit', '#editAircraftForm', function(e) {
        e.preventDefault();
        console.log('Edit form submitted'); // Debug log
        
        const aircraftId = $('#edit-aircraft-id').val();
        console.log('Aircraft ID for update:', aircraftId); // Debug log
        
        if (!aircraftId) {
            alert('Aircraft ID is missing');
            return;
        }
        
        // Get CSRF token from meta tag or cookie
        let csrfToken = $('meta[name=csrf-token]').attr('content');
        if (!csrfToken) {
            csrfToken = $('[name=csrfmiddlewaretoken]').val();
        }
        
        // Clean up form data - convert empty strings to null and handle numeric values
        const formData = {
            'registration_number': $('#edit-registration').val().trim(),
            'model_name': $('#edit-model').val().trim(),
            'year_manufactured': $('#edit-year').val().trim() || null,
            'base_airport': $('#edit-base').val().trim() || null,
            'current_location': $('#edit-location').val().trim() || null,
            'features': $('#edit-features').val().trim() || null,
            'hourly_rate': $('#edit-rate').val().trim() ? parseFloat($('#edit-rate').val()) : null,
            'minimum_hours': $('#edit-min-hours').val().trim() ? parseFloat($('#edit-min-hours').val()) : null,
            'is_active': $('#edit-status').val() === 'true',
            'owner_id': $('#edit-owner').val() || null,
            'aircraft_type_id': $('#edit-type').val() || null
        };
        
        console.log('Form data:', formData); // Debug log
        
        // Disable submit button to prevent double submission
        const submitBtn = $(this).find('button[type="submit"]');
        submitBtn.prop('disabled', true).text('Updating...');
        
        $.ajax({
            url: `/aircraft/${aircraftId}/update/`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            dataType: 'json',
            headers: {
                'X-CSRFToken': csrfToken
            },
            success: function(response) {
                console.log('Update response:', response); // Debug log
                
                if (response.success) {
                    alert(response.message || 'Aircraft updated successfully');
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editAircraftModal'));
                    if (modal) {
                        modal.hide();
                    }
                    // Reload page or refresh table
                    location.reload();
                } else {
                    alert(response.message || response.error || 'Failed to update aircraft');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error updating aircraft:', xhr.responseText);
                let errorMessage = 'Error updating aircraft: ' + error;
                
                // Try to parse error response
                try {
                    const errorResponse = JSON.parse(xhr.responseText);
                    if (errorResponse.message) {
                        errorMessage = errorResponse.message;
                    }
                    if (errorResponse.error) {
                        errorMessage = errorResponse.error;
                    }
                    if (errorResponse.errors) {
                        errorMessage += '\n' + JSON.stringify(errorResponse.errors);
                    }
                } catch (e) {
                    // If response is not JSON, show raw response
                    if (xhr.responseText && xhr.responseText.length < 200) {
                        errorMessage = xhr.responseText;
                    }
                }
                
                alert(errorMessage);
            },
            complete: function() {
                // Re-enable submit button
                submitBtn.prop('disabled', false).text('Update Aircraft');
            }
        });
    });

    // Delete Aircraft Modal
    $(document).on('click', '.delete-aircraft', function() {
        const aircraftId = $(this).data('aircraft-id');
        const row = $(this).closest('tr');
        const registration = row.find('td:nth-child(1)').text().trim();
        const model = row.find('td:nth-child(2)').text().trim();
        
        $('#delete-aircraft-info').html(`
            <strong>Registration:</strong> ${registration}<br>
            <strong>Model:</strong> ${model}
        `);
        $('#confirm-aircraft-delete').data('aircraft-id', aircraftId);
        
        const modal = new bootstrap.Modal(document.getElementById('deleteAircraftModal'));
        modal.show();
    });

    // Confirm Delete
    $(document).on('click', '#confirm-aircraft-delete', function() {
        const aircraftId = $(this).data('aircraft-id');
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteAircraftModal'));
        
        // Get CSRF token
        let csrfToken = $('meta[name=csrf-token]').attr('content');
        if (!csrfToken) {
            csrfToken = $('[name=csrfmiddlewaretoken]').val();
        }
        
        $.ajax({
            url: `/aircraft/${aircraftId}/delete/`,
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': csrfToken
            },
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    location.reload();
                } else {
                    alert(response.message || 'Failed to delete aircraft');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error deleting aircraft:', xhr.responseText);
                alert('Error deleting aircraft: ' + error);
            },
            complete: function() {
                if (modal) {
                    modal.hide();
                }
            }
        });
    });

    // Add Aircraft button
    $('#addAircraftBtn').click(function() {
        alert('Add new aircraft functionality would be implemented here');
    });
});
</script>
{% endblock %}