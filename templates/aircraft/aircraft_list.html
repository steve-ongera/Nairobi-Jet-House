{% extends 'base/base.html' %}

{% block title %}Aircraft Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">Aircraft Management</h3>
                </div>
                <div class="card-body">
                    <!-- Search and Filter Form -->
                    <form method="GET" class="mb-4">
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" name="search" class="form-control" 
                                       placeholder="Search by registration, model, or owner..." 
                                       value="{{ search }}">
                            </div>
                            <div class="col-md-3">
                                <select name="is_active" class="form-control">
                                    <option value="">All Status</option>
                                    <option value="true" {% if is_active == 'true' %}selected{% endif %}>Active Only</option>
                                    <option value="false" {% if is_active == 'false' %}selected{% endif %}>Inactive Only</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary">Search</button>
                                <a href="{% url 'aircraft_list' %}" class="btn btn-secondary">Clear</a>
                            </div>
                        </div>
                    </form>

                    <!-- Aircraft Table -->
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Registration</th>
                                    <th>Model</th>
                                    <th>Type</th>
                                    <th>Owner</th>
                                    <th>Year</th>
                                    <th>Status</th>
                                    <th>Hourly Rate</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for aircraft in aircrafts %}
                                <tr>
                                    <td><strong>{{ aircraft.registration_number }}</strong></td>
                                    <td>{{ aircraft.model_name }}</td>
                                    <td>{{ aircraft.aircraft_type.name }}</td>
                                    <td>{{ aircraft.owner.get_full_name|default:aircraft.owner.username }}</td>
                                    <td>{{ aircraft.year_manufactured }}</td>
                                    <td>
                                        {% if aircraft.is_active %}
                                            <span class="badge badge-success">Active</span>
                                        {% else %}
                                            <span class="badge badge-danger">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>${{ aircraft.hourly_rate }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info view-aircraft" data-id="{{ aircraft.id }}">View</button>
                                        <button class="btn btn-sm btn-warning edit-aircraft" data-id="{{ aircraft.id }}">Edit</button>
                                        <button class="btn btn-sm btn-danger delete-aircraft" data-id="{{ aircraft.id }}">Delete</button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center">No aircraft found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if aircrafts.has_other_pages %}
                    <nav aria-label="Aircraft pagination">
                        <ul class="pagination justify-content-center">
                            {% if aircrafts.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ aircrafts.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if is_active %}&is_active={{ is_active }}{% endif %}">Previous</a>
                                </li>
                            {% endif %}
                            
                            {% for num in aircrafts.paginator.page_range %}
                                {% if aircrafts.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if is_active %}&is_active={{ is_active }}{% endif %}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if aircrafts.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ aircrafts.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if is_active %}&is_active={{ is_active }}{% endif %}">Next</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Aircraft Modal -->
<div class="modal fade" id="aircraftModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">Aircraft Details</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="aircraftForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Registration Number</label>
                                <input type="text" class="form-control" id="registration_number" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Model Name</label>
                                <input type="text" class="form-control" id="model_name" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Aircraft Type</label>
                                <select class="form-control" id="aircraft_type_id" required>
                                    <option value="">Select Type</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Owner</label>
                                <select class="form-control" id="owner_id" required>
                                    <option value="">Select Owner</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Year Manufactured</label>
                                <input type="number" class="form-control" id="year_manufactured" min="1900" max="2030" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Base Airport</label>
                                <input type="text" class="form-control" id="base_airport" maxlength="10" placeholder="ICAO Code">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Current Location</label>
                                <input type="text" class="form-control" id="current_location" maxlength="10" placeholder="ICAO Code">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Hourly Rate ($)</label>
                                <input type="number" class="form-control" id="hourly_rate" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Minimum Hours</label>
                                <input type="number" class="form-control" id="minimum_hours" step="0.1" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Status</label>
                                <select class="form-control" id="is_active">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Features</label>
                        <textarea class="form-control" id="features" rows="3" placeholder="Aircraft features and amenities"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveAircraft" style="display: none;">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    let currentAircraftId = null;
    let isViewMode = true;
    
    // Load dropdown data on page load
    loadDropdownData();
    
    function loadDropdownData() {
        fetch('/aircraft/dropdown-data/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate owners dropdown
                    let ownerSelect = $('#owner_id');
                    ownerSelect.empty().append('<option value="">Select Owner</option>');
                    data.owners.forEach(function(owner) {
                        let name = owner.first_name && owner.last_name ? 
                            `${owner.first_name} ${owner.last_name}` : owner.username;
                        ownerSelect.append(`<option value="${owner.id}">${name}</option>`);
                    });
                    
                    // Populate aircraft types dropdown
                    let typeSelect = $('#aircraft_type_id');
                    typeSelect.empty().append('<option value="">Select Type</option>');
                    data.aircraft_types.forEach(function(type) {
                        typeSelect.append(`<option value="${type.id}">${type.name}</option>`);
                    });
                }
            })
            .catch(error => console.error('Error loading dropdown data:', error));
    }
    
    // View aircraft details
    $('.view-aircraft').click(function() {
        currentAircraftId = $(this).data('id');
        isViewMode = true;
        loadAircraftData(currentAircraftId, true);
    });
    
    // Edit aircraft
    $('.edit-aircraft').click(function() {
        currentAircraftId = $(this).data('id');
        isViewMode = false;
        loadAircraftData(currentAircraftId, false);
    });
    
    // Delete aircraft
    $('.delete-aircraft').click(function() {
        let aircraftId = $(this).data('id');
        if (confirm('Are you sure you want to delete this aircraft?')) {
            fetch(`/aircraft/${aircraftId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error occurred while deleting aircraft');
            });
        }
    });
    
    function loadAircraftData(aircraftId, viewOnly) {
        fetch(`/aircraft/${aircraftId}/detail/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let aircraftData = data.data;
                    
                    // Populate form
                    $('#registration_number').val(aircraftData.registration_number);
                    $('#model_name').val(aircraftData.model_name);
                    $('#year_manufactured').val(aircraftData.year_manufactured);
                    $('#base_airport').val(aircraftData.base_airport);
                    $('#current_location').val(aircraftData.current_location);
                    $('#features').val(aircraftData.features);
                    $('#hourly_rate').val(aircraftData.hourly_rate);
                    $('#minimum_hours').val(aircraftData.minimum_hours);
                    $('#is_active').val(aircraftData.is_active.toString());
                    $('#owner_id').val(aircraftData.owner_id);
                    $('#aircraft_type_id').val(aircraftData.aircraft_type_id);
                    
                    // Set modal title and form state
                    if (viewOnly) {
                        $('#modalTitle').text('View Aircraft Details');
                        $('#aircraftForm input, #aircraftForm select, #aircraftForm textarea').prop('disabled', true);
                        $('#saveAircraft').hide();
                    } else {
                        $('#modalTitle').text('Edit Aircraft');
                        $('#aircraftForm input, #aircraftForm select, #aircraftForm textarea').prop('disabled', false);
                        $('#saveAircraft').show();
                    }
                    
                    $('#aircraftModal').modal('show');
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error occurred while loading aircraft data');
            });
    }
    
    // Save aircraft changes
    $('#saveAircraft').click(function() {
        let formData = {
            registration_number: $('#registration_number').val(),
            model_name: $('#model_name').val(),
            year_manufactured: $('#year_manufactured').val(),
            base_airport: $('#base_airport').val(),
            current_location: $('#current_location').val(),
            features: $('#features').val(),
            hourly_rate: $('#hourly_rate').val(),
            minimum_hours: $('#minimum_hours').val(),
            is_active: $('#is_active').val() === 'true',
            owner_id: $('#owner_id').val(),
            aircraft_type_id: $('#aircraft_type_id').val()
        };
        
        fetch(`/aircraft/${currentAircraftId}/update/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                $('#aircraftModal').modal('hide');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error occurred while updating aircraft');
        });
    });
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}