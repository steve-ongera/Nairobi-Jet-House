
{% extends "base/base.html" %}

{% block content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-coins me-2"></i>Pricing Rules Management</h5>
        <button class="btn btn-sm btn-light" id="create-pricing-rule">
            <i class="fas fa-plus me-1"></i>Add New Rule
        </button>
    </div>
    <div class="card-body">
        <div id="pricing-rule-list">
            {% include 'pricing_rules/includes/partial_pricing_rule_list.html' %}
        </div>
    </div>
</div>

<!-- Empty modal div -->
<div class="modal fade" id="modal-pricing-rule" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- AJAX content will be loaded here -->
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#pricing-rule-table').DataTable({
        responsive: true
    });

    // Create pricing rule
    $("#create-pricing-rule").click(function() {
        $.ajax({
            url: "{% url 'pricing_rule_create' %}",
            type: 'get',
            dataType: 'json',
            beforeSend: function() {
                $("#modal-pricing-rule").modal("show");
            },
            success: function(data) {
                $("#modal-pricing-rule .modal-content").html(data.html_form);
            }
        });
    });

    // Update pricing rule
    $("#pricing-rule-list").on("click", ".update-pricing-rule", function() {
        var url = $(this).data("url");
        $.ajax({
            url: url,
            type: 'get',
            dataType: 'json',
            beforeSend: function() {
                $("#modal-pricing-rule").modal("show");
            },
            success: function(data) {
                $("#modal-pricing-rule .modal-content").html(data.html_form);
            }
        });
    });

    // Delete pricing rule
    $("#pricing-rule-list").on("click", ".delete-pricing-rule", function() {
        var url = $(this).data("url");
        $.ajax({
            url: url,
            type: 'get',
            dataType: 'json',
            beforeSend: function() {
                $("#modal-pricing-rule").modal("show");
            },
            success: function(data) {
                $("#modal-pricing-rule .modal-content").html(data.html_form);
            }
        });
    });

    // Handle form submission
    $("#modal-pricing-rule").on("submit", ".js-pricing-rule-form", function(e) {
        e.preventDefault();
        var form = $(this);
        $.ajax({
            url: form.attr("action"),
            data: form.serialize(),
            type: form.attr("method"),
            dataType: 'json',
            success: function(data) {
                if (data.form_is_valid) {
                    $("#pricing-rule-list").html(data.html_pricing_rule_list);
                    $("#modal-pricing-rule").modal("hide");
                    // Reinitialize DataTable
                    $('#pricing-rule-table').DataTable({
                        responsive: true
                    });
                } else {
                    $("#modal-pricing-rule .modal-content").html(data.html_form);
                }
            }
        });
    });
});
</script>
{% endblock %}