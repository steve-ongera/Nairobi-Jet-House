{% extends "base/base.html" %}
{% load static %}

{% block title %}Pricing Rules Management{% endblock %}

{% block content %}
<div class="pagetitle">
    <h1>Pricing Rules</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Home</a></li>
            <li class="breadcrumb-item active">Pricing Rules</li>
        </ol>
    </nav>
</div>

<section class="section">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Pricing Rules List</h5>
                    
                    <!-- Search and Add Button -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" id="search-input" class="form-control" placeholder="Search by aircraft type...">
                                <button class="btn btn-primary" id="search-btn">Search</button>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-success" id="add-rule-btn" data-bs-toggle="modal" data-bs-target="#ruleModal">
                                <i class="bi bi-plus-circle"></i> Add New Rule
                            </button>
                        </div>
                    </div>
                    
                    <!-- Pricing Rules Table -->
                    <div class="table-responsive">
                        <table id="pricingRulesTable" class="table table-hover datatable">
                            <thead>
                                <tr>
                                    <th>Aircraft Type</th>
                                    <th>Base Rate</th>
                                    <th>Min Hours</th>
                                    <th>Empty Leg</th>
                                    <th>Peak Multiplier</th>
                                    <th>Weekend</th>
                                    <th>Last Minute</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Add/Edit Pricing Rule Modal -->
<div class="modal fade" id="ruleModal" tabindex="-1" aria-labelledby="ruleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ruleModalLabel">Add New Pricing Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="pricingRuleForm">
                    <input type="hidden" id="ruleId" value="">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="aircraftType" class="form-label">Aircraft Type *</label>
                                <select class="form-select" id="aircraftType" required>
                                    <option value="">Select Aircraft Type</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="baseHourlyRate" class="form-label">Base Hourly Rate *</label>
                                <input type="number" step="0.01" class="form-control" id="baseHourlyRate" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="minimumHours" class="form-label">Minimum Hours</label>
                                <input type="number" step="0.1" class="form-control" id="minimumHours" value="1.0">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="emptyLegDiscount" class="form-label">Empty Leg Discount (%)</label>
                                <input type="number" step="0.1" class="form-control" id="emptyLegDiscount" value="0">
                            </div>
                            
                            <div class="mb-3">
                                <label for="peakSeasonMultiplier" class="form-label">Peak Season Multiplier</label>
                                <input type="number" step="0.1" class="form-control" id="peakSeasonMultiplier" value="1.0">
                            </div>
                            
                            <div class="mb-3">
                                <label for="weekendSurcharge" class="form-label">Weekend Surcharge (%)</label>
                                <input type="number" step="0.1" class="form-control" id="weekendSurcharge" value="0">
                            </div>
                            
                            <div class="mb-3">
                                <label for="lastMinuteSurcharge" class="form-label">Last Minute Surcharge (%)</label>
                                <input type="number" step="0.1" class="form-control" id="lastMinuteSurcharge" value="0">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveRuleBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this pricing rule?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>


<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTable
    var table = $('#pricingRulesTable').DataTable({
        ajax: {
            url: "{% url 'api_pricing_rules_list' %}",
            dataSrc: 'results'
        },
        columns: [
            { 
                data: 'aircraft_type.name',
                render: function(data, type, row) {
                    return `${row.aircraft_type.name} (${row.aircraft_type.passenger_capacity} pax)`;
                }
            },
            { data: 'base_hourly_rate' },
            { data: 'minimum_hours' },
            { data: 'empty_leg_discount' },
            { data: 'peak_season_multiplier' },
            { data: 'weekend_surcharge' },
            { data: 'last_minute_surcharge' },
            {
                data: 'id',
                render: function(data, type, row) {
                    return `
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-primary edit-btn" data-id="${data}" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${data}" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    `;
                },
                orderable: false
            }
        ],
        responsive: true
    });
    
    // Load aircraft types for dropdown
    $.get("{% url 'api_aircraft_types_list' %}", function(data) {
        var options = '<option value="">Select Aircraft Type</option>';
        $.each(data.results, function(index, type) {
            options += `<option value="${type.id}">${type.name}</option>`;
        });
        $('#aircraftType').html(options);
    });
    
    // Search functionality
    $('#search-btn').click(function() {
        table.ajax.url("{% url 'api_pricing_rules_list' %}?search=" + $('#search-input').val()).load();
    });
    
    $('#search-input').keypress(function(e) {
        if (e.which == 13) { // Enter key
            $('#search-btn').click();
        }
    });
    
    // Reset form when modal is shown for adding new rule
    $('#ruleModal').on('show.bs.modal', function(e) {
        $('#ruleModalLabel').text('Add New Pricing Rule');
        $('#pricingRuleForm')[0].reset();
        $('#ruleId').val('');
    });
    
    // Edit button click handler
    $(document).on('click', '.edit-btn', function() {
        var ruleId = $(this).data('id');
        
        $.get(`/api/pricing-rules/${ruleId}/`, function(data) {
            $('#ruleModalLabel').text('Edit Pricing Rule');
            $('#ruleId').val(data.id);
            $('#aircraftType').val(data.aircraft_type.id);
            $('#baseHourlyRate').val(data.base_hourly_rate);
            $('#minimumHours').val(data.minimum_hours);
            $('#emptyLegDiscount').val(data.empty_leg_discount);
            $('#peakSeasonMultiplier').val(data.peak_season_multiplier);
            $('#weekendSurcharge').val(data.weekend_surcharge);
            $('#lastMinuteSurcharge').val(data.last_minute_surcharge);
            
            $('#ruleModal').modal('show');
        }).fail(function() {
            alert('Failed to load pricing rule data');
        });
    });
    
    // Save rule handler
    $('#saveRuleBtn').click(function() {
        var formData = {
            aircraft_type: $('#aircraftType').val(),
            base_hourly_rate: $('#baseHourlyRate').val(),
            minimum_hours: $('#minimumHours').val(),
            empty_leg_discount: $('#emptyLegDiscount').val(),
            peak_season_multiplier: $('#peakSeasonMultiplier').val(),
            weekend_surcharge: $('#weekendSurcharge').val(),
            last_minute_surcharge: $('#lastMinuteSurcharge').val()
        };
        
        var ruleId = $('#ruleId').val();
        var url = ruleId ? `/api/pricing-rules/${ruleId}/update/` : '/api/pricing-rules/create/';
        var method = ruleId ? 'PUT' : 'POST';
        
        $.ajax({
            url: url,
            type: method,
            contentType: 'application/json',
            data: JSON.stringify(formData),
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                $('#ruleModal').modal('hide');
                table.ajax.reload();
                alert(ruleId ? 'Pricing rule updated successfully' : 'Pricing rule created successfully');
            },
            error: function(xhr) {
                var errorMsg = xhr.responseJSON && xhr.responseJSON.error ? 
                    xhr.responseJSON.error : 'An error occurred';
                alert('Error: ' + errorMsg);
            }
        });
    });
    
    // Delete button click handler
    var deleteRuleId;
    $(document).on('click', '.delete-btn', function() {
        deleteRuleId = $(this).data('id');
        $('#deleteModal').modal('show');
    });
    
    // Confirm delete handler
    $('#confirmDeleteBtn').click(function() {
        $.ajax({
            url: `/api/pricing-rules/${deleteRuleId}/delete/`,
            type: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                $('#deleteModal').modal('hide');
                table.ajax.reload();
                alert('Pricing rule deleted successfully');
            },
            error: function(xhr) {
                $('#deleteModal').modal('hide');
                alert('Failed to delete pricing rule');
            }
        });
    });
});
</script>
{% endblock %}