{% extends "base/base.html" %}
{% load static %}

{% block title %}New Booking{% endblock %}

{% block content %}
<div class="message-container" id="system-messages">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        <i class="bi {% if message.tags == 'success' %}bi-check-circle{% else %}bi-exclamation-triangle{% endif %} me-2"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>

<div class="pagetitle">
    <h1><i class="bi bi-journal-plus me-2"></i>New Booking</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}"><i class="bi bi-house-door"></i> Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'booking_list' %}">Bookings</a></li>
            <li class="breadcrumb-item active">New</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-jet-primary text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-calendar2-plus me-2"></i>Create New Flight Booking</h5>
                </div>
                
                <div class="card-body">
                    <form method="post" id="booking-form">
                        {% csrf_token %}
                        
                        <!-- Client Information Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-jet-light">
                                <h5 class="mb-0"><i class="bi bi-person-badge me-2"></i>Client Information</h5>
                            </div>
                            <div class="card-body">
                                <!-- Client Selection Toggle -->
                                <div class="mb-4">
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="client_selection" id="existing_client" 
                                            value="existing" autocomplete="off" {% if client_selection == 'existing' or not client_selection %}checked{% endif %}>
                                        <label class="btn btn-outline-jet" for="existing_client">
                                            <i class="bi bi-person-lines-fill me-1"></i> Existing Client
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="client_selection" id="new_client" 
                                            value="new" autocomplete="off" {% if client_selection == 'new' %}checked{% endif %}>
                                        <label class="btn btn-outline-jet" for="new_client">
                                            <i class="bi bi-person-plus me-1"></i> New Client
                                        </label>
                                    </div>
                                </div>

                                <!-- Existing Client Selection -->
                                <div id="existing-client-section" class="mb-3">
                                    <label for="id_client" class="form-label fw-bold">Select Client <span class="text-danger">*</span></label>
                                    <select name="client" id="id_client" class="form-select" required>
                                        <option value="">Choose a client...</option>
                                        {% for client in clients %}
                                            <option value="{{ client.id }}" {% if client.id == selected_client_id %}selected{% endif %}>
                                                {{ client.get_full_name|default:client.username }} ({{ client.email }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- New Client Creation Form -->
                                <div id="new-client-section" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ account_form.first_name.id_for_label }}" class="form-label fw-bold">First Name <span class="text-danger">*</span></label>
                                                {{ account_form.first_name }}
                                                {% if account_form.first_name.errors %}
                                                    <div class="text-danger small">{{ account_form.first_name.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ account_form.last_name.id_for_label }}" class="form-label fw-bold">Last Name <span class="text-danger">*</span></label>
                                                {{ account_form.last_name }}
                                                {% if account_form.last_name.errors %}
                                                    <div class="text-danger small">{{ account_form.last_name.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ account_form.email.id_for_label }}" class="form-label fw-bold">Email <span class="text-danger">*</span></label>
                                                {{ account_form.email }}
                                                {% if account_form.email.errors %}
                                                    <div class="text-danger small">{{ account_form.email.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ account_form.phone_number.id_for_label }}" class="form-label fw-bold">Phone</label>
                                                {{ account_form.phone_number }}
                                                {% if account_form.phone_number.errors %}
                                                    <div class="text-danger small">{{ account_form.phone_number.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Additional fields for new client -->
                                     <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="{{ account_form.username.id_for_label }}" class="form-label">Username *</label>
                                                {{ account_form.username }}
                                                {% if account_form.username.errors %}
                                                    <div class="text-danger">{{ account_form.username.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="{{ account_form.password1.id_for_label }}" class="form-label">Password *</label>
                                                {{ account_form.password1 }}
                                                {% if account_form.password1.errors %}
                                                    <div class="text-danger">{{ account_form.password1.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="{{ account_form.password2.id_for_label }}" class="form-label">Confirm Password *</label>
                                                {{ account_form.password2 }}
                                                {% if account_form.password2.errors %}
                                                    <div class="text-danger">{{ account_form.password2.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ account_form.company_name.id_for_label }}" class="form-label fw-bold">Company Name</label>
                                                {{ account_form.company_name }}
                                            </div>
                                        </div>
                                        <!--
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ account_form.tax_id.id_for_label }}" class="form-label fw-bold">Tax ID</label>
                                                {{ account_form.tax_id }}
                                            </div>
                                        </div>-->
                                    </div>

                                    <div class="mb-3">
                                        <label for="{{ account_form.address.id_for_label }}" class="form-label fw-bold">Address</label>
                                        {{ account_form.address }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const existingClientRadio = document.getElementById('existing_client');
                            const newClientRadio = document.getElementById('new_client');
                            const existingClientSection = document.getElementById('existing-client-section');
                            const newClientSection = document.getElementById('new-client-section');
                            const clientSelect = document.getElementById('id_client');

                            function toggleClientSections() {
                                if (existingClientRadio.checked) {
                                    existingClientSection.style.display = 'block';
                                    newClientSection.style.display = 'none';
                                    clientSelect.required = true;
                                    
                                    // Remove required from new client form fields
                                    const newClientInputs = newClientSection.querySelectorAll('input[required]');
                                    newClientInputs.forEach(input => input.required = false);
                                } else if (newClientRadio.checked) {
                                    existingClientSection.style.display = 'none';
                                    newClientSection.style.display = 'block';
                                    clientSelect.required = false;
                                    clientSelect.value = '';
                                    
                                    // Add required to new client form fields
                                    const requiredFields = ['id_first_name', 'id_last_name', 'id_email', 'id_username', 'id_password1', 'id_password2'];
                                    requiredFields.forEach(fieldId => {
                                        const field = document.getElementById(fieldId);
                                        if (field) field.required = true;
                                    });
                                }
                            }

                            // Initial setup
                            toggleClientSections();

                            // Add event listeners
                            existingClientRadio.addEventListener('change', toggleClientSections);
                            newClientRadio.addEventListener('change', toggleClientSections);
                        });
                        </script>

                        <!-- Booking Details Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-jet-light">
                                <h5 class="mb-0"><i class="bi bi-calendar2-event me-2"></i>Booking Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ booking_form.aircraft.id_for_label }}" class="form-label fw-bold">Aircraft <span class="text-danger">*</span></label>
                                            {{ booking_form.aircraft }}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ booking_form.trip_type.id_for_label }}" class="form-label fw-bold">Trip Type <span class="text-danger">*</span></label>
                                            {{ booking_form.trip_type }}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="passenger_count" class="form-label fw-bold">Passengers <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="passenger_count" name="passenger_count" value="1" min="1" max="20">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="leg_count" class="form-label fw-bold">Flight Legs <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="leg_count" name="leg_count" value="1" min="1" max="10">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ booking_form.special_requests.id_for_label }}" class="form-label fw-bold">Special Requests</label>
                                    {{ booking_form.special_requests }}
                                </div>
                            </div>
                        </div>

                        <!-- Flight Legs Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-jet-light d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-route me-2"></i>Flight Legs</h5>
                                <button type="button" class="btn btn-sm btn-jet" id="add-leg">
                                    <i class="bi bi-plus-circle me-1"></i> Add Leg
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="flight-legs-container">
                                    {% for leg_form in leg_forms %}
                                    <div class="card mb-3 flight-leg" data-leg-index="0">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">Flight Leg #1</h6>
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-leg">
                                                <i class="bi bi-trash"></i> Remove
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label fw-bold">Departure Airport <span class="text-danger">*</span></label>
                                                        {{ leg_form.departure_airport }}
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label fw-bold">Arrival Airport <span class="text-danger">*</span></label>
                                                        {{ leg_form.arrival_airport }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label fw-bold">Departure Date & Time <span class="text-danger">*</span></label>
                                                        {{ leg_form.departure_datetime }}
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label fw-bold">Arrival Date & Time <span class="text-danger">*</span></label>
                                                        {{ leg_form.arrival_datetime }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label fw-bold">Flight Hours <span class="text-danger">*</span></label>
                                                        {{ leg_form.flight_hours }}
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label fw-bold">Distance (nm)</label>
                                                        {{ leg_form.distance_nm }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Passengers Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-jet-light">
                                <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Passengers</h5>
                            </div>
                            <div class="card-body">
                                <div id="passengers-container">
                                    {% for passenger_form in passenger_forms %}
                                    <div class="card mb-3 passenger-form" data-passenger-index="0">
                                        <div class="card-header">
                                            <h6 class="mb-0">Passenger #1</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label fw-bold">Full Name <span class="text-danger">*</span></label>
                                                        {{ passenger_form.name }}
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label fw-bold">Nationality</label>
                                                        {{ passenger_form.nationality }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label fw-bold">Date of Birth</label>
                                                        {{ passenger_form.date_of_birth }}
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label fw-bold">Passport Number</label>
                                                        {{ passenger_form.passport_number }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Pricing & Availability Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-jet-light">
                                <h5 class="mb-0"><i class="bi bi-cash-coin me-2"></i>Pricing & Availability</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex gap-2 mb-3">
                                    <button type="button" class="btn btn-outline-jet" id="check-availability">
                                        <i class="bi bi-search me-1"></i> Check Availability
                                    </button>
                                    <button type="button" class="btn btn-jet" id="calculate-price">
                                        <i class="bi bi-calculator me-1"></i> Calculate Price
                                    </button>
                                </div>
                                
                                <div class="alert alert-info" id="availability-status" style="display: none;">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <span id="availability-message">Availability not checked yet</span>
                                </div>
                                
                                <div class="card bg-light" id="pricing-info" style="display: none;">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="bi bi-receipt me-2"></i>Price Estimate</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p class="mb-1"><strong>Base Price:</strong> <span id="base-price">$0.00</span></p>
                                                <p class="mb-1"><strong>Taxes & Fees:</strong> <span id="taxes">$0.00</span></p>
                                            </div>
                                            <div class="col-md-6">
                                                <p class="mb-1"><strong>Discounts:</strong> <span id="discounts">$0.00</span></p>
                                                <h5 class="mt-2"><strong>Total Price:</strong> <span id="total-price" class="text-success">$0.00</span></h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Section -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-jet btn-lg px-4">
                                <i class="bi bi-save me-2"></i> Create Booking
                            </button>
                            <a href="{% url 'booking_list' %}" class="btn btn-outline-secondary btn-lg px-4">
                                <i class="bi bi-x-circle me-2"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    :root {
        --jet-primary: #1976D2;
        --jet-secondary: #64B5F6;
        --jet-light: #E3F2FD;
        --jet-dark: #0D47A1;
    }
    
    .bg-jet-primary {
        background-color: var(--jet-primary) !important;
    }
    
    .bg-jet-light {
        background-color: var(--jet-light) !important;
    }
    
    .btn-jet {
        background-color: var(--jet-primary);
        color: white;
        border-color: var(--jet-primary);
    }
    
    .btn-jet:hover {
        background-color: var(--jet-dark);
        border-color: var(--jet-dark);
        color: white;
    }
    
    .btn-outline-jet {
        color: var(--jet-primary);
        border-color: var(--jet-primary);
    }
    
    .btn-outline-jet:hover {
        background-color: var(--jet-primary);
        color: white;
    }
    
    .flight-leg {
        border-left: 3px solid var(--jet-primary);
    }
    
    .passenger-form {
        border-left: 3px solid #28a745;
    }
    
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0,0,0,.1);
        border-radius: 50%;
        border-top-color: var(--jet-primary);
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>


<!-- View Booking Modal -->
<div class="modal fade" id="viewBookingModal" tabindex="-1" aria-labelledby="viewBookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewBookingModalLabel">Booking Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="card-title">Booking Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Booking ID:</label>
                                            <p id="booking-id" class="form-control-static">-</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Trip Type:</label>
                                            <p id="booking-trip-type" class="form-control-static">-</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Status:</label>
                                            <p id="booking-status" class="form-control-static">-</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Created:</label>
                                            <p id="booking-created" class="form-control-static">-</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Last Updated:</label>
                                            <p id="booking-updated" class="form-control-static">-</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Payment Status:</label>
                                            <p id="booking-payment" class="form-control-static">-</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="card-title">Client Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Name:</label>
                                    <p id="client-name" class="form-control-static">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Email:</label>
                                    <p id="client-email" class="form-control-static">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Phone:</label>
                                    <p id="client-phone" class="form-control-static">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="card-title">Aircraft Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Model:</label>
                                    <p id="aircraft-model" class="form-control-static">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Registration:</label>
                                    <p id="aircraft-reg" class="form-control-static">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Type:</label>
                                    <p id="aircraft-type" class="form-control-static">-</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="card-title">Financial Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Total Price:</label>
                                            <p id="total-price" class="form-control-static">-</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Commission Rate:</label>
                                            <p id="commission-rate" class="form-control-static">-</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Agent Commission:</label>
                                            <p id="agent-commission" class="form-control-static">-</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Owner Earnings:</label>
                                            <p id="owner-earnings" class="form-control-static">-</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="card-title">Flight Legs</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm" id="flight-legs-table">
                                <thead>
                                    <tr>
                                        <th>Departure</th>
                                        <th>Arrival</th>
                                        <th>Date & Time</th>
                                        <th>Passengers</th>
                                        <th>Flight Hours</th>
                                        <th>Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title">Special Requests</h6>
                    </div>
                    <div class="card-body">
                        <p id="special-requests" class="form-control-static">-</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script>
$(document).ready(function() {
    // Client type toggle
    $('input[name="client_type"]').change(function() {
        if ($(this).val() === 'existing') {
            $('#client-selection').show();
            $('#client-creation').hide();
            $('#client-creation input').prop('required', false);
        } else {
            $('#client-selection').hide();
            $('#client-creation').show();
            $('#client-creation input[type="email"], #client-creation input[name*="first_name"], #client-creation input[name*="last_name"]').prop('required', true);
        }
    });

    // Dynamic leg count
    $('#leg_count').change(function() {
        updateFlightLegs(parseInt($(this).val()));
    });

    // Dynamic passenger count
    $('#passenger_count').change(function() {
        updatePassengers(parseInt($(this).val()));
    });

    // Add flight leg
    $('#add-leg').click(function() {
        var currentCount = $('#flight-legs-container .flight-leg').length;
        $('#leg_count').val(currentCount + 1).trigger('change');
    });

    // Remove flight leg
    $(document).on('click', '.remove-leg', function() {
        var legContainer = $(this).closest('.flight-leg');
        var currentCount = $('#flight-legs-container .flight-leg').length;
        
        if (currentCount > 1) {
            legContainer.remove();
            $('#leg_count').val(currentCount - 1);
            updateLegNumbers();
        } else {
            alert('At least one flight leg is required.');
        }
    });

    // Check availability
    $('#check-availability').click(function() {
        checkAvailability();
    });

    // Calculate price
    $('#calculate-price').click(function() {
        calculatePrice();
    });

    // Auto-calculate arrival time when departure time or flight hours change
    $(document).on('change', 'input[name*="departure_datetime"], input[name*="flight_hours"]', function() {
        var legContainer = $(this).closest('.flight-leg');
        calculateArrivalTime(legContainer);
    });

    // Form submission with client type handling
    $('#booking-form').submit(function(e) {
        var clientType = $('input[name="client_type"]:checked').val();
        
        if (clientType === 'new') {
            // Add create_account flag
            $(this).append('<input type="hidden" name="create_account" value="1">');
        }
    });

    function updateFlightLegs(count) {
        var container = $('#flight-legs-container');
        var currentCount = container.find('.flight-leg').length;
        
        if (count > currentCount) {
            // Add new legs
            for (var i = currentCount; i < count; i++) {
                addFlightLeg(i);
            }
        } else if (count < currentCount) {
            // Remove legs
            container.find('.flight-leg').slice(count).remove();
        }
        
        updateLegNumbers();
    }

    function addFlightLeg(index) {
        var legHtml = `
            <div class="flight-leg" data-leg-index="${index}">
                <h5>Flight Leg #${index + 1}</h5>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label>Departure Airport <span class="required-field">*</span></label>
                            <select name="leg_${index}-departure_airport" class="form-control" required>
                                <option value="">Select Airport</option>
                                {% for airport in airports %}
                                <option value="{{ airport.id }}">{{ airport.code }} - {{ airport.name }} ({{ airport.city }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label>Arrival Airport <span class="required-field">*</span></label>
                            <select name="leg_${index}-arrival_airport" class="form-control" required>
                                <option value="">Select Airport</option>
                                {% for airport in airports %}
                                <option value="{{ airport.id }}">{{ airport.code }} - {{ airport.name }} ({{ airport.city }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label>Departure Date & Time <span class="required-field">*</span></label>
                            <input type="datetime-local" name="leg_${index}-departure_datetime" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label>Arrival Date & Time <span class="auto-calculated">(Auto-calculated)</span></label>
                            <input type="datetime-local" name="leg_${index}-arrival_datetime" class="form-control arrival-auto" readonly 
                                   style="background-color: #f8f9fa; cursor: not-allowed;" 
                                   title="This field is automatically calculated based on departure time and flight hours">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label>Flight Hours <span class="required-field">*</span></label>
                            <input type="number" name="leg_${index}-flight_hours" class="form-control" step="0.1" min="0.1" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <button type="button" class="btn btn-remove btn-sm remove-leg" style="margin-top: 32px;">
                            <i class="fas fa-trash"></i> Remove Leg
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        $('#flight-legs-container').append(legHtml);
    }

    function updatePassengers(count) {
        var container = $('#passengers-container');
        var currentCount = container.find('.passenger-form').length;
        
        if (count > currentCount) {
            // Add new passengers
            for (var i = currentCount; i < count; i++) {
                addPassengerForm(i);
            }
        } else if (count < currentCount) {
            // Remove passengers
            container.find('.passenger-form').slice(count).remove();
        }
        
        updatePassengerNumbers();
    }

    function addPassengerForm(index) {
        var passengerHtml = `
            <div class="passenger-form" data-passenger-index="${index}">
                <h5>Passenger #${index + 1}</h5>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label>Full Name <span class="required-field">*</span></label>
                            <input type="text" name="passenger_${index}-name" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label>Nationality</label>
                            <input type="text" name="passenger_${index}-nationality" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" name="passenger_${index}-date_of_birth" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label>Passport Number</label>
                            <input type="text" name="passenger_${index}-passport_number" class="form-control">
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $('#passengers-container').append(passengerHtml);
    }

    function updateLegNumbers() {
        $('#flight-legs-container .flight-leg').each(function(index) {
            $(this).find('h5').text('Flight Leg #' + (index + 1));
            $(this).attr('data-leg-index', index);
        });
    }

    function updatePassengerNumbers() {
        $('#passengers-container .passenger-form').each(function(index) {
            $(this).find('h5').text('Passenger #' + (index + 1));
            $(this).attr('data-passenger-index', index);
        });
    }

    // NEW FUNCTION: Auto-calculate arrival time based on departure time + flight hours
    function calculateArrivalTime(legContainer) {
        var departureInput = legContainer.find('input[name*="departure_datetime"]');
        var arrivalInput = legContainer.find('input[name*="arrival_datetime"]');
        var hoursInput = legContainer.find('input[name*="flight_hours"]');
        
        var departureTime = departureInput.val();
        var flightHours = parseFloat(hoursInput.val());
        
        if (departureTime && flightHours && flightHours > 0) {
            var departure = new Date(departureTime);
            
            // Add flight hours to departure time
            var arrivalTime = new Date(departure.getTime() + (flightHours * 60 * 60 * 1000));
            
            // Format the date for datetime-local input (YYYY-MM-DDTHH:MM)
            var year = arrivalTime.getFullYear();
            var month = String(arrivalTime.getMonth() + 1).padStart(2, '0');
            var day = String(arrivalTime.getDate()).padStart(2, '0');
            var hours = String(arrivalTime.getHours()).padStart(2, '0');
            var minutes = String(arrivalTime.getMinutes()).padStart(2, '0');
            
            var formattedDateTime = year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
            
            // Set the calculated arrival time
            arrivalInput.val(formattedDateTime);
            
            // Add visual feedback
            arrivalInput.css('background-color', '#e8f5e8');
            setTimeout(function() {
                arrivalInput.css('background-color', '#f8f9fa');
            }, 2000);
        } else {
            // Clear arrival time if inputs are invalid
            arrivalInput.val('');
        }
    }

    function checkAvailability() {
        var aircraftId = $('select[name="aircraft"]').val();
        var flightLegs = getFlightLegsData();
        
        if (!aircraftId) {
            alert('Please select an aircraft first.');
            return;
        }
        
        if (flightLegs.length === 0) {
            alert('Please fill in at least one flight leg.');
            return;
        }
        
        var button = $('#check-availability');
        var originalText = button.html();
        button.html('<span class="spinner"></span> Checking...').prop('disabled', true);
        
        $.ajax({
            url: '{% url "ajax_check_availability" %}',
            method: 'POST',
            data: JSON.stringify({
                aircraft_id: aircraftId,
                flight_legs: flightLegs
            }),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                var statusDiv = $('#availability-status');
                statusDiv.removeClass('availability-available availability-unavailable');
                
                if (response.available) {
                    statusDiv.addClass('availability-available');
                    statusDiv.html('<i class="fas fa-check-circle"></i> ' + response.message);
                } else {
                    statusDiv.addClass('availability-unavailable');
                    statusDiv.html('<i class="fas fa-exclamation-triangle"></i> ' + response.message);
                }
                
                statusDiv.show();
            },
            error: function(xhr) {
                var errorMsg = 'Error checking availability';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                
                $('#availability-status')
                    .removeClass('availability-available')
                    .addClass('availability-unavailable')
                    .html('<i class="fas fa-exclamation-triangle"></i> ' + errorMsg)
                    .show();
            },
            complete: function() {
                button.html(originalText).prop('disabled', false);
            }
        });
    }

    function calculatePrice() {
        var aircraftId = $('select[name="aircraft"]').val();
        var flightLegs = getFlightLegsData();
        var tripType = $('select[name="trip_type"]').val();
        
        if (!aircraftId) {
            alert('Please select an aircraft first.');
            return;
        }
        
        if (flightLegs.length === 0) {
            alert('Please fill in at least one flight leg.');
            return;
        }
        
        var button = $('#calculate-price');
        var originalText = button.html();
        button.html('<span class="spinner"></span> Calculating...').prop('disabled', true);
        
        $.ajax({
            url: '{% url "ajax_calculate_price" %}',
            method: 'POST',
            data: JSON.stringify({
                aircraft_id: aircraftId,
                flight_legs: flightLegs,
                trip_type: tripType
            }),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                var pricingDiv = $('#pricing-info');
                var html = `
                    <h5><i class="fas fa-calculator"></i> Pricing Breakdown</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Total Flight Hours:</strong> ${response.total_hours} hours</p>
                            <p><strong>Base Hourly Rate:</strong> $${response.base_hourly_rate.toFixed(2)}</p>
                            <p><strong>Commission Rate:</strong> ${response.commission_rate.toFixed(1)}%</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Total Price:</strong> <span class="text-success h5">$${response.total_price.toFixed(2)}</span></p>
                            <p><strong>Agent Commission:</strong> $${response.agent_commission.toFixed(2)}</p>
                            <p><strong>Owner Earnings:</strong> $${response.owner_earnings.toFixed(2)}</p>
                        </div>
                    </div>
                `;
                pricingDiv.html(html).show();
            },
            error: function(xhr) {
                var errorMsg = 'Error calculating price';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                
                $('#pricing-info')
                    .html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ' + errorMsg + '</div>')
                    .show();
            },
            complete: function() {
                button.html(originalText).prop('disabled', false);
            }
        });
    }

    function getFlightLegsData() {
        var legs = [];
        
        $('#flight-legs-container .flight-leg').each(function() {
            var legIndex = $(this).data('leg-index');
            var departureAirport = $(this).find('select[name*="departure_airport"]').val();
            var arrivalAirport = $(this).find('select[name*="arrival_airport"]').val();
            var departureDateTime = $(this).find('input[name*="departure_datetime"]').val();
            var arrivalDateTime = $(this).find('input[name*="arrival_datetime"]').val();
            var flightHours = $(this).find('input[name*="flight_hours"]').val();
            
            if (departureAirport && arrivalAirport && departureDateTime && arrivalDateTime && flightHours) {
                legs.push({
                    departure_airport: departureAirport,
                    arrival_airport: arrivalAirport,
                    departure_datetime: new Date(departureDateTime).toISOString(),
                    arrival_datetime: new Date(arrivalDateTime).toISOString(),
                    flight_hours: parseFloat(flightHours)
                });
            }
        });
        
        return legs;
    }
});

// Status filter functionality (keeping this separate)
$(document).ready(function() {
    $('#applyFilter').click(function() {
        const status = $('#statusFilter').val();
        if (status) {
            window.location.href = `?status=${status}`;
        } else {
            window.location.href = '?';
        }
    });

    // View/Edit/Delete booking modal functionality remains the same...
    // (keeping existing booking management code as is)
});

// Flight Hours Auto-Calculation (Enhanced Version)
document.addEventListener('DOMContentLoaded', function() {
    // Function to calculate flight hours automatically
    function calculateFlightHours(legIndex) {
        const aircraftSelect = document.querySelector('select[name="aircraft"]');
        const departureSelect = document.querySelector(`select[name="leg_${legIndex}-departure_airport"]`);
        const arrivalSelect = document.querySelector(`select[name="leg_${legIndex}-arrival_airport"]`);
        const flightHoursInput = document.querySelector(`input[name="leg_${legIndex}-flight_hours"]`);
        
        if (!aircraftSelect || !departureSelect || !arrivalSelect || !flightHoursInput) {
            return;
        }
        
        const aircraftId = aircraftSelect.value;
        const departureAirportId = departureSelect.value;
        const arrivalAirportId = arrivalSelect.value;
        
        if (aircraftId && departureAirportId && arrivalAirportId && departureAirportId !== arrivalAirportId) {
            // Show loading state without changing the input value
            flightHoursInput.style.backgroundColor = '#f0f0f0';
            flightHoursInput.style.position = 'relative';
            flightHoursInput.disabled = true;
            
            // Create or update loading indicator
            let loadingIndicator = flightHoursInput.parentNode.querySelector('.loading-indicator');
            if (!loadingIndicator) {
                loadingIndicator = document.createElement('small');
                loadingIndicator.className = 'loading-indicator';
                loadingIndicator.style.cssText = 'color: #666; font-style: italic; margin-left: 5px;';
                flightHoursInput.parentNode.appendChild(loadingIndicator);
            }
            loadingIndicator.textContent = 'Calculating...';
            
            fetch('/ajax/calculate-flight-hours/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    aircraft_id: aircraftId,
                    departure_airport_id: departureAirportId,
                    arrival_airport_id: arrivalAirportId
                })
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading indicator
                const loadingIndicator = flightHoursInput.parentNode.querySelector('.loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                
                if (data.error) {
                    console.error('Error calculating flight hours:', data.error);
                    flightHoursInput.value = '';
                    flightHoursInput.style.backgroundColor = '#ffe6e6';
                    
                    // Show error message
                    const errorMsg = document.createElement('small');
                    errorMsg.textContent = 'Auto-calculation failed';
                    errorMsg.style.color = 'red';
                    errorMsg.className = 'error-message';
                    flightHoursInput.parentNode.appendChild(errorMsg);
                    setTimeout(() => errorMsg.remove(), 3000);
                } else {
                    flightHoursInput.value = data.flight_hours;
                    flightHoursInput.style.backgroundColor = '#e6ffe6';
                    
                    // Show success message
                    const successMsg = document.createElement('small');
                    successMsg.textContent = 'Auto-calculated';
                    successMsg.style.color = 'green';
                    successMsg.className = 'success-message';
                    flightHoursInput.parentNode.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 2000);
                    
                    // Trigger arrival time calculation after flight hours are set
                    const legContainer = flightHoursInput.closest('.flight-leg');
                    if (legContainer) {
                        $(legContainer).trigger('flightHoursUpdated');
                    }
                }
            })
            .catch(error => {
                console.error('Network error:', error);
                
                // Remove loading indicator
                const loadingIndicator = flightHoursInput.parentNode.querySelector('.loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                
                flightHoursInput.value = '';
                flightHoursInput.style.backgroundColor = '#ffe6e6';
                
                // Show error message
                const errorMsg = document.createElement('small');
                errorMsg.textContent = 'Network error occurred';
                errorMsg.style.color = 'red';
                errorMsg.className = 'error-message';
                flightHoursInput.parentNode.appendChild(errorMsg);
                setTimeout(() => errorMsg.remove(), 3000);
            })
            .finally(() => {
                flightHoursInput.disabled = false;
                
                // Clean up any remaining indicators
                const loadingIndicator = flightHoursInput.parentNode.querySelector('.loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                
                // Reset background color after a delay
                setTimeout(() => {
                    flightHoursInput.style.backgroundColor = '';
                }, 3000);
            });
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function attachFlightLegListeners(legIndex) {
        const aircraftSelect = document.querySelector('select[name="aircraft"]');
        const departureSelect = document.querySelector(`select[name="leg_${legIndex}-departure_airport"]`);
        const arrivalSelect = document.querySelector(`select[name="leg_${legIndex}-arrival_airport"]`);
        
        if (aircraftSelect) {
            aircraftSelect.addEventListener('change', () => calculateFlightHours(legIndex));
        }
        
        if (departureSelect) {
            departureSelect.addEventListener('change', () => calculateFlightHours(legIndex));
        }
        
        if (arrivalSelect) {
            arrivalSelect.addEventListener('change', () => calculateFlightHours(legIndex));
        }
    }
    
    function initializeFlightHoursCalculation() {
        const flightHoursInputs = document.querySelectorAll('input[name*="flight_hours"]');
        flightHoursInputs.forEach(input => {
            const match = input.name.match(/leg_(\d+)-flight_hours/);
            if (match) {
                const legIndex = parseInt(match[1]);
                attachFlightLegListeners(legIndex);
            }
        });
    }
    
    initializeFlightHoursCalculation();
    
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) {
                        const flightHoursInputs = node.querySelectorAll ? 
                            node.querySelectorAll('input[name*="flight_hours"]') : [];
                        
                        flightHoursInputs.forEach(input => {
                            const match = input.name.match(/leg_(\d+)-flight_hours/);
                            if (match) {
                                const legIndex = parseInt(match[1]);
                                attachFlightLegListeners(legIndex);
                            }
                        });
                    }
                });
            }
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
    
    window.calculateFlightHours = calculateFlightHours;
    window.attachFlightLegListeners = attachFlightLegListeners;
});
</script>

{% comment %}
<script>
$(document).ready(function() {
    // Status filter functionality
    $('#applyFilter').click(function() {
        const status = $('#statusFilter').val();
        if (status) {
            window.location.href = `?status=${status}`;
        } else {
            window.location.href = '?';
        }
    });

    // View Booking Modal
    $('.view-booking').click(function() {
        const bookingId = $(this).data('booking-id');
        const modal = new bootstrap.Modal(document.getElementById('viewBookingModal'));
        
        // Show loading state
        $('#viewBookingModal .modal-body p').text('Loading...');
        $('#flight-legs-table tbody').html('<tr><td colspan="6" class="text-center">Loading...</td></tr>');
        
        // Fetch booking details via AJAX
        $.ajax({
            url: '/bookings/' + bookingId + '/detail/',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    const booking = response.booking;
                    
                    // Update booking info
                    $('#booking-id').text(booking.booking_order_id);
                    $('#booking-trip-type').text(booking.trip_type);
                    $('#booking-status').text(booking.status);
                    $('#booking-created').text(booking.created_at);
                    $('#booking-updated').text(booking.updated_at);
                    $('#booking-payment').text(booking.payment_status);
                    
                    // Update client info
                    $('#client-name').text(booking.client.name);
                    $('#client-email').text(booking.client.email);
                    $('#client-phone').text(booking.client.phone);
                    
                    // Update aircraft info
                    $('#aircraft-model').text(booking.aircraft.model);
                    $('#aircraft-reg').text(booking.aircraft.registration);
                    $('#aircraft-type').text(booking.aircraft.type);
                    
                    // Update financial info
                    $('#total-price').text('$' + booking.total_price);
                    $('#commission-rate').text(booking.commission_rate + '%');
                    $('#agent-commission').text('$' + booking.agent_commission);
                    $('#owner-earnings').text('$' + booking.owner_earnings);
                    
                    // Update flight legs
                    const legsTable = $('#flight-legs-table tbody');
                    legsTable.empty();
                    
                    if (booking.flight_legs.length > 0) {
                        booking.flight_legs.forEach(function(leg) {
                            legsTable.append(`
                                <tr>
                                    <td>${leg.departure}</td>
                                    <td>${leg.arrival}</td>
                                    <td>
                                        ${leg.departure_datetime}<br>
                                        to ${leg.arrival_datetime}
                                    </td>
                                    <td>${leg.passenger_count}</td>
                                    <td>${leg.flight_hours}</td>
                                    <td>$${leg.leg_price}</td>
                                </tr>
                            `);
                        });
                    } else {
                        legsTable.append('<tr><td colspan="6" class="text-center">No flight legs found</td></tr>');
                    }
                    
                    // Update special requests
                    $('#special-requests').text(booking.special_requests);
                    
                    // Update modal title
                    $('#viewBookingModalLabel').text(`Booking Details: ${booking.booking_order_id}`);
                } else {
                    alert(response.error || 'Failed to load booking details');
                }
            },
            error: function(xhr, status, error) {
                alert('Error fetching booking details: ' + error);
            },
            complete: function() {
                modal.show();
            }
        });
    });

    // Edit Booking Modal
    $('.edit-booking').click(function() {
        const bookingId = $(this).data('booking-id');
        const row = $(this).closest('tr');
        const currentStatus = row.find('td:nth-child(6) .badge').text().trim();
        
        $('#edit-booking-id').val(bookingId);
        
        // Set current status in dropdown
        $('#booking-status-select').val(function() {
            const statusMap = {
                'Pending': 'pending',
                'Confirmed': 'confirmed',
                'Completed': 'completed',
                'Cancelled': 'cancelled'
            };
            return statusMap[currentStatus] || 'pending';
        });
        
        const modal = new bootstrap.Modal(document.getElementById('editBookingModal'));
        modal.show();
    });

    // Submit Edit Form
    $('#editBookingForm').submit(function(e) {
        e.preventDefault();
        const bookingId = $('#edit-booking-id').val();
        
        $.ajax({
            url: '/bookings/' + bookingId + '/update/',
            type: 'POST',
            data: $(this).serialize(),
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    // Refresh the page to see changes
                    location.reload();
                } else {
                    alert(response.error || 'Failed to update booking status');
                }
            },
            error: function(xhr, status, error) {
                alert('Error updating booking status: ' + error);
            }
        });
    });

    // Delete Booking Modal
    $('.delete-booking').click(function() {
        const bookingId = $(this).data('booking-id');
        const row = $(this).closest('tr');
        const bookingRef = row.find('td:nth-child(1)').text().trim();
        
        $('#delete-booking-id').text(bookingRef);
        $('#confirm-booking-delete').data('booking-id', bookingId);
        
        const modal = new bootstrap.Modal(document.getElementById('deleteBookingModal'));
        modal.show();
    });

    // Confirm Delete
    $('#confirm-booking-delete').click(function() {
        const bookingId = $(this).data('booking-id');
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteBookingModal'));
        
        $.ajax({
            url: '/bookings/' + bookingId + '/delete/',
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    // Refresh the page to see changes
                    location.reload();
                } else {
                    alert(response.error || 'Failed to delete booking');
                }
            },
            error: function(xhr, status, error) {
                alert('Error deleting booking: ' + error);
            },
            complete: function() {
                modal.hide();
            }
        });
    });
});
</script>
<script>
    // Flight Hours Auto-Calculation JavaScript
// Add this to your existing JavaScript file or in a script tag

document.addEventListener('DOMContentLoaded', function() {
    // Function to calculate flight hours automatically
    function calculateFlightHours(legIndex) {
        const aircraftSelect = document.querySelector('select[name="aircraft"]');
        const departureSelect = document.querySelector(`select[name="leg_${legIndex}-departure_airport"]`);
        const arrivalSelect = document.querySelector(`select[name="leg_${legIndex}-arrival_airport"]`);
        const flightHoursInput = document.querySelector(`input[name="leg_${legIndex}-flight_hours"]`);
        
        if (!aircraftSelect || !departureSelect || !arrivalSelect || !flightHoursInput) {
            return;
        }
        
        const aircraftId = aircraftSelect.value;
        const departureAirportId = departureSelect.value;
        const arrivalAirportId = arrivalSelect.value;
        
        // Only calculate if all required fields are selected
        if (aircraftId && departureAirportId && arrivalAirportId && departureAirportId !== arrivalAirportId) {
            // Show loading indicator
            flightHoursInput.style.backgroundColor = '#f0f0f0';
            flightHoursInput.value = 'Calculating...';
            flightHoursInput.disabled = true;
            
            // Make AJAX request to calculate flight hours
            fetch('/ajax/calculate-flight-hours/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    aircraft_id: aircraftId,
                    departure_airport_id: departureAirportId,
                    arrival_airport_id: arrivalAirportId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error calculating flight hours:', data.error);
                    flightHoursInput.value = '';
                    flightHoursInput.style.backgroundColor = '#ffe6e6';
                    // Show error message briefly
                    const errorMsg = document.createElement('small');
                    errorMsg.textContent = 'Auto-calculation failed';
                    errorMsg.style.color = 'red';
                    flightHoursInput.parentNode.appendChild(errorMsg);
                    setTimeout(() => errorMsg.remove(), 3000);
                } else {
                    flightHoursInput.value = data.flight_hours;
                    flightHoursInput.style.backgroundColor = '#e6ffe6';
                    
                    // Show success message briefly
                    const successMsg = document.createElement('small');
                    successMsg.textContent = 'Auto-calculated';
                    successMsg.style.color = 'green';
                    flightHoursInput.parentNode.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 2000);
                    
                    // Trigger price calculation if available
                    if (typeof calculatePrice === 'function') {
                        calculatePrice();
                    }
                }
            })
            .catch(error => {
                console.error('Network error:', error);
                flightHoursInput.value = '';
                flightHoursInput.style.backgroundColor = '#ffe6e6';
            })
            .finally(() => {
                flightHoursInput.disabled = false;
                setTimeout(() => {
                    flightHoursInput.style.backgroundColor = '';
                }, 3000);
            });
        }
    }
    
    // Function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Function to attach event listeners to flight leg fields
    function attachFlightLegListeners(legIndex) {
        const aircraftSelect = document.querySelector('select[name="aircraft"]');
        const departureSelect = document.querySelector(`select[name="leg_${legIndex}-departure_airport"]`);
        const arrivalSelect = document.querySelector(`select[name="leg_${legIndex}-arrival_airport"]`);
        
        if (aircraftSelect) {
            aircraftSelect.addEventListener('change', () => calculateFlightHours(legIndex));
        }
        
        if (departureSelect) {
            departureSelect.addEventListener('change', () => calculateFlightHours(legIndex));
        }
        
        if (arrivalSelect) {
            arrivalSelect.addEventListener('change', () => calculateFlightHours(legIndex));
        }
    }
    
    // Initialize listeners for existing flight legs
    function initializeFlightHoursCalculation() {
        // Find all existing flight leg forms
        const legForms = document.querySelectorAll('[id^="leg_"], [class*="leg-form"]');
        legForms.forEach((form, index) => {
            attachFlightLegListeners(index);
        });
        
        // If no specific leg forms found, try to find by input names
        const flightHoursInputs = document.querySelectorAll('input[name*="flight_hours"]');
        flightHoursInputs.forEach(input => {
            const match = input.name.match(/leg_(\d+)-flight_hours/);
            if (match) {
                const legIndex = parseInt(match[1]);
                attachFlightLegListeners(legIndex);
            }
        });
    }
    
    // Initialize on page load
    initializeFlightHoursCalculation();
    
    // Re-initialize when new flight legs are added dynamically
    // This handles cases where you might be adding flight legs via JavaScript
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) { // Element node
                        const flightHoursInputs = node.querySelectorAll ? 
                            node.querySelectorAll('input[name*="flight_hours"]') : [];
                        
                        flightHoursInputs.forEach(input => {
                            const match = input.name.match(/leg_(\d+)-flight_hours/);
                            if (match) {
                                const legIndex = parseInt(match[1]);
                                attachFlightLegListeners(legIndex);
                            }
                        });
                    }
                });
            }
        });
    });
    
    // Start observing
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
    
    // Enhanced flight hours input behavior
    document.addEventListener('focus', function(e) {
        if (e.target.name && e.target.name.includes('flight_hours')) {
            // Allow manual override by clearing auto-calculated value on focus
            if (e.target.style.backgroundColor === 'rgb(230, 255, 230)') {
                e.target.style.backgroundColor = '';
            }
        }
    }, true);
    
    // Debounced calculation for better performance
    let calculationTimeout;
    function debouncedCalculateFlightHours(legIndex) {
        clearTimeout(calculationTimeout);
        calculationTimeout = setTimeout(() => calculateFlightHours(legIndex), 500);
    }
    
    // Export functions for external use if needed
    window.calculateFlightHours = calculateFlightHours;
    window.attachFlightLegListeners = attachFlightLegListeners;
});

// Additional utility function for manual calculation trigger
function triggerFlightHoursCalculation() {
    const flightHoursInputs = document.querySelectorAll('input[name*="flight_hours"]');
    flightHoursInputs.forEach(input => {
        const match = input.name.match(/leg_(\d+)-flight_hours/);
        if (match) {
            const legIndex = parseInt(match[1]);
            calculateFlightHours(legIndex);
        }
    });
}
</script>
{% endcomment %}

{% endblock %}