{% extends "base/base.html" %}
{% load static %}

{% block title %}Booking Management{% endblock %}

{% block content %}
<div class="pagetitle">
    <h1><i class="bi bi-journal-check"></i> Booking Management</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}"><i class="bi bi-house-door"></i> Home</a></li>
            <li class="breadcrumb-item active">Bookings</li>
        </ol>
    </nav>
</div>

<section class="section">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Booking List</h5>

                    <!-- Status Filter -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <select class="form-select" id="statusFilter">
                                <option value="">All Statuses</option>
                                {% for value, label in status_choices %}
                                    <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" id="applyFilter">Apply Filter</button>
                        </div>
                    </div>

                    <!-- Bookings Table -->
                    <div class="table-responsive">
                        <table class="table table-hover datatable align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Booking ID</th>
                                    <th>Client</th>
                                    <th>Aircraft</th>
                                    <th>Trip Type</th>
                                    <th>Departure</th>
                                    <th>Status</th>
                                    <th>Total Price</th>
                                    <th>Payment</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for booking in page_obj %}
                                    <tr>
                                        <td>
                                            {{ booking.booking_order_id }}
                                            <div class="text-muted small">{{ booking.created_at|date:"M d, Y" }}</div>
                                        </td>
                                        <td>{{ booking.client.get_full_name }}</td>
                                        <td>
                                            {{ booking.aircraft.model_name }}
                                            <div class="text-muted small">{{ booking.aircraft.registration_number }}</div>
                                        </td>
                                        <td>{{ booking.get_trip_type_display }}</td>
                                        <td>
                                            {% with first_leg=booking.flight_legs.first %}
                                                {{ first_leg.departure_airport.icao_code }}
                                                <div class="text-muted small">
                                                    {{ first_leg.departure_datetime|date:"M d, H:i" }}
                                                </div>
                                            {% endwith %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ booking.status|yesno:'success,warning,danger,info' }}">
                                                {{ booking.get_status_display }}
                                            </span>
                                        </td>
                                        <td>${{ booking.total_price }}</td>
                                        <td>
                                            <span class="badge bg-{{ booking.payment_status|yesno:'success,warning' }}">
                                                {% if booking.payment_status %}Paid{% else %}Pending{% endif %}
                                            </span>
                                        </td>
                                        <td class="d-flex gap-1">
                                            <button class="btn btn-sm btn-primary view-booking" title="View Details" data-booking-id="{{ booking.id }}">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-warning edit-booking" title="Edit Status" data-booking-id="{{ booking.id }}">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger delete-booking" title="Delete Booking" data-booking-id="{{ booking.id }}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mt-4">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1" aria-label="First">
                                        <span aria-hidden="true">&laquo;&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %}
                                    <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Last">
                                        <span aria-hidden="true">&raquo;&raquo;</span>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</section>



<!-- View Booking Modal -->
<div class="modal fade" id="viewBookingModal" tabindex="-1" aria-labelledby="viewBookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewBookingModalLabel">Booking Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="card-title">Booking Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Booking ID:</label>
                                            <p id="booking-id" class="form-control-static">-</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Trip Type:</label>
                                            <p id="booking-trip-type" class="form-control-static">-</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Status:</label>
                                            <p id="booking-status" class="form-control-static">-</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Created:</label>
                                            <p id="booking-created" class="form-control-static">-</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Last Updated:</label>
                                            <p id="booking-updated" class="form-control-static">-</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Payment Status:</label>
                                            <p id="booking-payment" class="form-control-static">-</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="card-title">Client Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Name:</label>
                                    <p id="client-name" class="form-control-static">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Email:</label>
                                    <p id="client-email" class="form-control-static">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Phone:</label>
                                    <p id="client-phone" class="form-control-static">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="card-title">Aircraft Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Model:</label>
                                    <p id="aircraft-model" class="form-control-static">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Registration:</label>
                                    <p id="aircraft-reg" class="form-control-static">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Type:</label>
                                    <p id="aircraft-type" class="form-control-static">-</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="card-title">Financial Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Total Price:</label>
                                            <p id="total-price" class="form-control-static">-</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Commission Rate:</label>
                                            <p id="commission-rate" class="form-control-static">-</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Agent Commission:</label>
                                            <p id="agent-commission" class="form-control-static">-</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Owner Earnings:</label>
                                            <p id="owner-earnings" class="form-control-static">-</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="card-title">Flight Legs</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm" id="flight-legs-table">
                                <thead>
                                    <tr>
                                        <th>Departure</th>
                                        <th>Arrival</th>
                                        <th>Date & Time</th>
                                        <th>Passengers</th>
                                        <th>Flight Hours</th>
                                        <th>Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="card-title">Passengers</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm" id="passengers-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Passport</th>
                                        <th>Nationality</th>
                                        <th>Date of Birth</th>
                                        <th>Order Ref</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title">Special Requests</h6>
                    </div>
                    <div class="card-body">
                        <p id="special-requests" class="form-control-static">-</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Booking Status Modal -->
<div class="modal fade" id="editBookingModal" tabindex="-1" aria-labelledby="editBookingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editBookingModalLabel">Update Booking Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editBookingForm">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="edit-booking-id" name="booking_id">
                    
                    <div class="mb-3">
                        <label for="booking-status-select" class="form-label">Booking Status</label>
                        <select class="form-select" id="booking-status-select" name="status" required>
                            {% for value, label in status_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Payment Status</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_status" id="payment-unpaid" value="false" checked>
                            <label class="form-check-label" for="payment-unpaid">
                                Unpaid
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_status" id="payment-paid" value="true">
                            <label class="form-check-label" for="payment-paid">
                                Paid
                            </label>
                        </div>
                    </div>
                    
                    <!-- Alternative: If you want a checkbox instead of radio buttons -->
                    <!-- 
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="payment-status-check" name="payment_status" value="true">
                            <label class="form-check-label" for="payment-status-check">
                                Payment Received
                            </label>
                        </div>
                    </div>
                    -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Booking Modal -->
<div class="modal fade" id="deleteBookingModal" tabindex="-1" aria-labelledby="deleteBookingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteBookingModalLabel">Confirm Booking Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this booking?</p>
                <p class="fw-bold" id="delete-booking-id"></p>
                <p class="text-danger">This action cannot be undone and will remove all associated flight legs.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-booking-delete">Delete Booking</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    // Status filter functionality
    $('#applyFilter').click(function() {
        const status = $('#statusFilter').val();
        if (status) {
            window.location.href = `?status=${status}`;
        } else {
            window.location.href = '?';
        }
    });

    // View Booking Modal
    $('.view-booking').click(function() {
        const bookingId = $(this).data('booking-id');
        const modal = new bootstrap.Modal(document.getElementById('viewBookingModal'));
        
        // Show loading state
        $('#viewBookingModal .modal-body p').text('Loading...');
        $('#flight-legs-table tbody').html('<tr><td colspan="6" class="text-center">Loading...</td></tr>');
        
        // Fetch booking details via AJAX
        $.ajax({
            url: '/bookings/' + bookingId + '/detail/',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    const booking = response.booking;
                    
                    // Update booking info
                    $('#booking-id').text(booking.booking_order_id);
                    $('#booking-trip-type').text(booking.trip_type);
                    $('#booking-status').text(booking.status);
                    $('#booking-created').text(booking.created_at);
                    $('#booking-updated').text(booking.updated_at);
                    $('#booking-payment').text(booking.payment_status);
                    
                    // Update client info
                    $('#client-name').text(booking.client.name);
                    $('#client-email').text(booking.client.email);
                    $('#client-phone').text(booking.client.phone);
                    
                    // Update aircraft info
                    $('#aircraft-model').text(booking.aircraft.model);
                    $('#aircraft-reg').text(booking.aircraft.registration);
                    $('#aircraft-type').text(booking.aircraft.type);
                    
                    // Update financial info
                    $('#total-price').text('$' + booking.total_price);
                    $('#commission-rate').text(booking.commission_rate + '%');
                    $('#agent-commission').text('$' + booking.agent_commission);
                    $('#owner-earnings').text('$' + booking.owner_earnings);
                    
                    // Update flight legs to show full airport names
                    const legsTable = $('#flight-legs-table tbody');
                    legsTable.empty();

                    if (booking.flight_legs.length > 0) {
                        booking.flight_legs.forEach(function(leg) {
                            legsTable.append(`
                                <tr>
                                    <td>
                                        ${leg.departure_code}<br>
                                        <small class="text-muted">${leg.departure_name}</small>
                                    </td>
                                    <td>
                                        ${leg.arrival_code}<br>
                                        <small class="text-muted">${leg.arrival_name}</small>
                                    </td>
                                    <td>
                                        ${leg.departure_datetime}<br>
                                        to ${leg.arrival_datetime}
                                    </td>
                                    <td>${leg.passenger_count}</td>
                                    <td>${leg.flight_hours}</td>
                                    <td>$${leg.leg_price}</td>
                                </tr>
                            `);
                        });
                    } else {
                        legsTable.append('<tr><td colspan="6" class="text-center">No flight legs found</td></tr>');
                    }

                    // Update passengers table
                    const passengersTable = $('#passengers-table tbody');
                    passengersTable.empty();

                    if (booking.passengers && booking.passengers.length > 0) {
                        booking.passengers.forEach(function(passenger) {
                            passengersTable.append(`
                                <tr>
                                    <td>${passenger.name}</td>
                                    <td>${passenger.passport_number || 'N/A'}</td>
                                    <td>${passenger.nationality || 'N/A'}</td>
                                    <td>${passenger.date_of_birth || 'N/A'}</td>
                                    <td>${passenger.order || 'N/A'}</td>
                                </tr>
                            `);
                        });
                    } else {
                        passengersTable.append('<tr><td colspan="5" class="text-center">No passengers found</td></tr>');
                    }
                    
                    // Update special requests
                    $('#special-requests').text(booking.special_requests);
                    
                    // Update modal title
                    $('#viewBookingModalLabel').text(`Booking Details: ${booking.booking_order_id}`);
                } else {
                    alert(response.error || 'Failed to load booking details');
                }
            },
            error: function(xhr, status, error) {
                alert('Error fetching booking details: ' + error);
            },
            complete: function() {
                modal.show();
            }
        });
    });

    // Edit Booking Modal
    $('.edit-booking').click(function() {
        const bookingId = $(this).data('booking-id');
        const row = $(this).closest('tr');
        const currentStatus = row.find('td:nth-child(6) .badge').text().trim();
        const currentPaymentStatus = row.find('.payment-status').text().trim(); // Assuming you have payment status in table
        
        $('#edit-booking-id').val(bookingId);
        
        // Set current status in dropdown
        $('#booking-status-select').val(function() {
            const statusMap = {
                'Pending': 'pending',
                'Confirmed': 'confirmed',
                'Completed': 'completed',
                'Cancelled': 'cancelled'
            };
            return statusMap[currentStatus] || 'pending';
        });
        
        // Set current payment status
        if (currentPaymentStatus === 'Paid' || currentPaymentStatus === 'True') {
            $('#payment-paid').prop('checked', true);
        } else {
            $('#payment-unpaid').prop('checked', true);
        }
        
        const modal = new bootstrap.Modal(document.getElementById('editBookingModal'));
        modal.show();
    });

    // Submit Edit Form - UPDATED WITH AUTO-REFRESH
    $('#editBookingForm').submit(function(e) {
        e.preventDefault();
        const bookingId = $('#edit-booking-id').val();
        
        // Get CSRF token
        const csrfToken = $('[name=csrfmiddlewaretoken]').val() || 
                         $('meta[name=csrf-token]').attr('content') || 
                         document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        
        // Show loading state on submit button
        const submitBtn = $(this).find('[type="submit"]');
        const originalText = submitBtn.text();
        submitBtn.prop('disabled', true).text('Updating...');
        
        $.ajax({
            url: '/bookings/' + bookingId + '/update/',
            type: 'POST',
            data: $(this).serialize(),
            dataType: 'json',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.success) {
                    // Show success message
                    let message = response.message;
                    if (response.booking && response.booking.payment_status_display) {
                        message += `\nPayment status: ${response.booking.payment_status_display}`;
                    }
                    
                    // Close modal first
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editBookingModal'));
                    modal.hide();
                    
                    // Show success message
                    alert(message);
                    
                    // Auto-refresh the page after successful update
                    setTimeout(function() {
                        location.reload();
                    }, 500); // Small delay to ensure modal closes properly
                    
                } else {
                    // Reset button state on error
                    submitBtn.prop('disabled', false).text(originalText);
                    alert(response.error || 'Failed to update booking status');
                }
            },
            error: function(xhr, status, error) {
                // Reset button state on error
                submitBtn.prop('disabled', false).text(originalText);
                
                let errorMessage = 'Error updating booking status: ' + error;
                if (xhr.status === 405) {
                    errorMessage = 'Method not allowed. Please check the URL configuration.';
                } else if (xhr.status === 403) {
                    errorMessage = 'Permission denied. Please check your authentication.';
                } else if (xhr.status === 404) {
                    errorMessage = 'Booking not found.';
                }
                alert(errorMessage);
            }
        });
    });

    // Delete Booking Modal
    $('.delete-booking').click(function() {
        const bookingId = $(this).data('booking-id');
        const row = $(this).closest('tr');
        const bookingRef = row.find('td:nth-child(1)').text().trim();
        
        $('#delete-booking-id').text(bookingRef);
        $('#confirm-booking-delete').data('booking-id', bookingId);
        
        const modal = new bootstrap.Modal(document.getElementById('deleteBookingModal'));
        modal.show();
    });

    // Confirm Delete - UPDATED WITH AUTO-REFRESH
    $('#confirm-booking-delete').click(function() {
        const bookingId = $(this).data('booking-id');
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteBookingModal'));
        
        // Get CSRF token
        const csrfToken = $('[name=csrfmiddlewaretoken]').val() || 
                         $('meta[name=csrf-token]').attr('content') || 
                         document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        
        // Show loading state
        const deleteBtn = $(this);
        const originalText = deleteBtn.text();
        deleteBtn.prop('disabled', true).text('Deleting...');
        
        $.ajax({
            url: '/bookings/' + bookingId + '/delete/',
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': csrfToken
            },
            dataType: 'json',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.success) {
                    // Close modal
                    modal.hide();
                    
                    // Show success message
                    alert(response.message);
                    
                    // Auto-refresh the page after successful deletion
                    setTimeout(function() {
                        location.reload();
                    }, 500);
                    
                } else {
                    // Reset button state on error
                    deleteBtn.prop('disabled', false).text(originalText);
                    alert(response.error || 'Failed to delete booking');
                }
            },
            error: function(xhr, status, error) {
                // Reset button state on error
                deleteBtn.prop('disabled', false).text(originalText);
                alert('Error deleting booking: ' + error);
            }
        });
    });

    // Optional: Add a more elegant notification system instead of alerts
    function showNotification(message, type = 'success') {
        // Create notification element
        const notification = $(`
            <div class="alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `);
        
        // Add to body
        $('body').append(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(function() {
            notification.alert('close');
        }, 3000);
    }

    // Alternative success handler with elegant notifications (uncomment to use)
    /*
    function handleBookingUpdateSuccess(response) {
        // Close any open modals
        $('.modal').modal('hide');
        
        // Show elegant notification
        showNotification(response.message, 'success');
        
        // Auto-refresh after showing notification
        setTimeout(function() {
            location.reload();
        }, 1500);
    }
    */
});
</script>
{% endblock %}